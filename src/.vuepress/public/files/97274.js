exports.id=97274,exports.ids=[97274],exports.modules={28247:()=>{},22011:(e,t,a)=>{"use strict";var n;a.d(t,{Mv:()=>r,ns:()=>n,w8:()=>o}),(n||(n={})).dataset="dataset";let r={[n.dataset]:{label:"common.file.bucket.dataset"}},o="/api/common/file/read"},18824:(e,t,a)=>{},11730:(e,t,a)=>{"use strict";var n;a.d(t,{AJ:()=>r,XJ:()=>n,tY:()=>o,vX:()=>s});let r="/api/system/img/";!function(e){e.systemAvatar="systemAvatar",e.appAvatar="appAvatar",e.pluginAvatar="pluginAvatar",e.datasetAvatar="datasetAvatar",e.userAvatar="userAvatar",e.teamAvatar="teamAvatar",e.chatImage="chatImage",e.collectionImage="collectionImage"}(n||(n={}));let o={[n.systemAvatar]:{label:"common.file.type.appAvatar",unique:!0},[n.appAvatar]:{label:"common.file.type.appAvatar",unique:!0},[n.pluginAvatar]:{label:"common.file.type.pluginAvatar",unique:!0},[n.datasetAvatar]:{label:"common.file.type.datasetAvatar",unique:!0},[n.userAvatar]:{label:"common.file.type.userAvatar",unique:!0},[n.teamAvatar]:{label:"common.file.type.teamAvatar",unique:!0},[n.chatImage]:{label:"common.file.type.chatImage",unique:!1},[n.collectionImage]:{label:"common.file.type.collectionImage",unique:!1}};Object.entries(o).filter(([e,t])=>t.unique).map(([e])=>e);let s="/imgs/workflow/http.png"},98237:(e,t,a)=>{"use strict";a.d(t,{K:()=>r});var n=a(18481);let r=e=>n.detect(e.slice(0,200))?.encoding?.toLocaleLowerCase()},63092:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{_U:()=>l,aB:()=>s});var r=a(935),o=e([r]);r=(o.then?(await o)():o)[0];let s=e=>{e=(e=(0,r.Av)(e)).replace(/\[([^\]]+)\]\((.+?)\)/g,(e,t,a)=>{let n=t.replace(/\n/g," ").trim();return a?`[${n}](${a})`:""});let t=/\\([#`!*()+-_\[\]{}\\.])/g;return t.test(e)&&(e=e.replace(t,"$1")),e=e.replace(/\\\\n/g,"\\n"),["####","###","##","#","```","~~~"].forEach((t,a)=>{let n=RegExp(`\\n\\s*${t}`,"g");n.test(e)&&(e=e.replace(RegExp(`(\\n)( *)(${t})`,"g"),"$1$3"))}),e.trim()},i=async({rawText:e,uploadImgController:t})=>{if(t){let a=e.match(/data:image\/.*;base64,([^\)]+)/g)||[];for await(let n of a)try{let a=await t(n);e=e.replace(n,a)}catch(t){e=(e=e.replace(n,"")).replace(/!\[.*\]\(\)/g,"")}}let a=/(!\[.*\]\(.*\))\s*/g;return a.test(e)&&(e=e.replace(a,"$1")),e},l=async({rawText:e,uploadImgController:t})=>{let a=await i({rawText:e,uploadImgController:t});return s(a)};n()}catch(e){n(e)}})},59666:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{N:()=>i});var r=a(66743),o=a(935),s=e([r,o]);[r,o]=s.then?(await s)():s;let i=e=>{let{text:t="",chunkLen:a,overlapRatio:n=.2,customReg:s=[]}=e,i="SPLIT_HERE_SPLIT_HERE",l="CODE_BLOCK_LINE_MARKER",c=Math.round(a*n);t=t.replace(/(```[\s\S]*?```|~~~[\s\S]*?~~~)/g,function(e){return e.replace(/\n/g,l)});let d=[...s.map(e=>({reg:RegExp(`(${(0,o.wH)(e)})`,"g"),maxLen:1.4*a})),{reg:/^(#\s[^\n]+)\n/gm,maxLen:1.2*a},{reg:/^(##\s[^\n]+)\n/gm,maxLen:1.2*a},{reg:/^(###\s[^\n]+)\n/gm,maxLen:1.2*a},{reg:/^(####\s[^\n]+)\n/gm,maxLen:1.2*a},{reg:/([\n]([`~]))/g,maxLen:4*a},{reg:/([\n](?!\s*[\*\-|>0-9]))/g,maxLen:2*a},{reg:/([\n])/g,maxLen:1.2*a},{reg:/([。]|([a-zA-Z])\.\s)/g,maxLen:1.2*a},{reg:/([！]|!\s)/g,maxLen:1.2*a},{reg:/([？]|\?\s)/g,maxLen:1.4*a},{reg:/([；]|;\s)/g,maxLen:1.6*a},{reg:/([，]|,\s)/g,maxLen:2*a}],u=s.length,m=e=>e<u,p=e=>e>=u&&e<=3+u,y=e=>e>=u&&e<=4+u,f=e=>e<=6+u,g=({text:e,step:t})=>{if(t>=d.length)return[{text:e,title:""}];let a=m(t),n=p(t),r=y(t),{reg:o}=d[t],s=e.replace(o,a?i:r?`${i}$1`:`$1${i}`).split(`${i}`).filter(e=>e.trim());return s.map(e=>{let t=n&&e.match(o)?.[0]||"";return{text:n?e.replace(t,""):e,title:t}}).filter(e=>e.text.trim())},h=({text:e,step:t})=>{let n=f(t),r=.4*a;if(n||0===c||t>=d.length)return"";let o=g({text:e,step:t}),s="";for(let e=o.length-1;e>=0;e--){let a=o[e].text,n=a+s,i=n.length;if(i>c){if(i>r){let e=h({text:n,step:t+1});return e||s}return n}s=n}return s},w=({text:e="",step:t,lastText:n,mdTitle:r=""})=>{let o=y(t),s=m(t);if(t>=d.length){if(e.length<3*a)return[e];let t=[];for(let n=0;n<e.length;n+=a-c)t.push(`${r}${e.slice(n,n+a)}`);return t}let i=g({text:e,step:t}),l=i.length>1?d[t].maxLen:a,u=.7*a,p=[];for(let e=0;e<i.length;e++){let c=i[e],d=`${r}${c.title}`,m=c.text,y=m.length,f=n.length,g=n+m,b=f+y;if(b>l){if(f>u){p.push(`${d}${n}`),n=h({text:n,step:t}),e--;continue}let a=w({text:g,step:t+1,lastText:"",mdTitle:d}),r=a[a.length-1];!o&&r.length<u?(p.push(...a.slice(0,-1)),n=r):(p.push(...a),n=h({text:r,step:t}));continue}n=g,(s||o&&b>30||b>=a)&&(p.push(`${d}${n}`),n=h({text:n,step:t}))}return n&&p[p.length-1]&&!p[p.length-1].endsWith(n)?n.length<.4*a?p[p.length-1]=p[p.length-1]+n:p.push(`${r}${n}`):n&&0===p.length&&p.push(n),p};try{let e=w({text:t,step:0,lastText:"",mdTitle:""}).map(e=>e?.replaceAll(l,"\n")||""),a=e.reduce((e,t)=>e+t.length,0);return{chunks:e,chars:a}}catch(e){throw Error((0,r.v)(e))}};n()}catch(e){n(e)}})},11953:(e,t,a)=>{"use strict";a.d(t,{t2:()=>i});var n=a(1635),r=a.n(n),o=a(13977),s=a.n(o);let i=({cronString:e,timezone:t})=>{try{let a={currentDate:r()().tz(t).format(),tz:t},n=s().parseExpression(e,a),o=n.next().toString();return new Date(o)}catch(e){return new Date("2099")}}},68150:(e,t,a)=>{"use strict";var n;a.d(t,{H:()=>n,_:()=>r}),function(e){e.fastgpt="fastgpt",e.fastgptPro="fastgptPro",e.systemMsgModal="systemMsgModal"}(n||(n={}));let r={[n.fastgpt]:{label:"fastgpt"},[n.fastgptPro]:{label:"fastgptPro"},[n.systemMsgModal]:{label:"systemMsgModal"}}},10071:(e,t,a)=>{"use strict";a.d(t,{g:()=>n});let n=e=>new Promise(t=>{setTimeout(()=>{t("")},e)})},3126:(e,t,a)=>{"use strict";a.d(t,{iE:()=>d}),a(98257);var n=a(1635),r=a.n(n),o=a(36619),s=a.n(o),i=a(53291),l=a.n(i);r().extend(s()),r().extend(l());let c=e=>{let t=new Date,a=t.toLocaleString("en-US",{timeZone:e}),n=t.toLocaleString("en-US"),r=(Date.parse(n)-Date.parse(a))/36e5,o=r+t.getTimezoneOffset()/60;return-o},d=e=>{let t=c(e),a=Date.now();return r()(a+36e5*t).format("YYYY-MM-DD HH:mm:ss dddd")}},93556:(e,t,a)=>{"use strict";var n,r,o,s;a.d(t,{NZ:()=>n,hZ:()=>s}),function(e){e.System="system",e.User="user",e.Assistant="assistant",e.Function="function",e.Tool="tool"}(n||(n={})),function(e){e.text="text",e.image_url="image_url"}(r||(r={})),function(e){e.all="all",e.classify="classify",e.extractFields="extractFields",e.toolCall="toolCall",e.queryExtension="queryExtension"}(o||(o={})),o.all,o.classify,o.extractFields,o.toolCall,o.queryExtension,function(e){e.query="query",e.db="db"}(s||(s={}))},39309:(e,t,a)=>{"use strict";a.d(t,{C:()=>n,K:()=>r});let n=[{title:"标准模板",desc:"标准提示词，用于结构不固定的知识库。",value:`{{q}}
{{a}}`},{title:"问答模板",desc:"适合 QA 问答结构的知识库，可以让AI较为严格的按预设内容回答",value:`<Question>
{{q}}
</Question>
<Answer>
{{a}}
</Answer>`},{title:"标准严格模板",desc:"在标准模板基础上，对模型的回答做更严格的要求。",value:`{{q}}
{{a}}`},{title:"严格问答模板",desc:"在问答模板基础上，对模型的回答做更严格的要求。",value:`<Question>
{{q}}
</Question>
<Answer>
{{a}}
</Answer>`}],r=[{title:"标准模板",desc:"",value:`使用 <Data></Data> 标记中的内容作为你的知识:

<Data>
{{quote}}
</Data>

回答要求：
- 如果你不清楚答案，你需要澄清。
- 避免提及你是从 <Data></Data> 获取的知识。
- 保持答案与 <Data></Data> 中描述的一致。
- 使用 Markdown 语法优化回答格式。
- 使用与问题相同的语言回答。

问题:"""{{question}}"""`},{title:"问答模板",desc:"",value:`使用 <QA></QA> 标记中的问答对进行回答。

<QA>
{{quote}}
</QA>

回答要求：
- 选择其中一个或多个问答对进行回答。
- 回答的内容应尽可能与 <答案></答案> 中的内容一致。
- 如果没有相关的问答对，你需要澄清。
- 避免提及你是从 QA 获取的知识，只需要回复答案。

问题:"""{{question}}"""`},{title:"标准严格模板",desc:"",value:`忘记你已有的知识，仅使用 <Data></Data> 标记中的内容作为你的知识:

<Data>
{{quote}}
</Data>

思考流程：
1. 判断问题是否与 <Data></Data> 标记中的内容有关。
2. 如果有关，你按下面的要求回答。
3. 如果无关，你直接拒绝回答本次问题。

回答要求：
- 避免提及你是从 <Data></Data> 获取的知识。
- 保持答案与 <Data></Data> 中描述的一致。
- 使用 Markdown 语法优化回答格式。
- 使用与问题相同的语言回答。

问题:"""{{question}}"""`},{title:"严格问答模板",desc:"",value:`忘记你已有的知识，仅使用 <QA></QA> 标记中的问答对进行回答。

<QA>
{{quote}}
</QA>}

思考流程：
1. 判断问题是否与 <QA></QA> 标记中的内容有关。
2. 如果无关，你直接拒绝回答本次问题。
3. 判断是否有相近或相同的问题。
4. 如果有相同的问题，直接输出对应答案。
5. 如果只有相近的问题，请把相近的问题和答案一起输出。

最后，避免提及你是从 QA 获取的知识，只需要回复答案。

问题:"""{{question}}"""`}]},44201:(e,t,a)=>{"use strict";a.d(t,{c5:()=>n,qA:()=>o,wL:()=>r});let n={description:`<Context></Context> 标记中是一段文本，学习和分析它，并整理学习成果：
- 提出问题并给出每个问题的答案。
- 答案需详细完整，尽可能保留原文描述。
- 答案可以包含普通文字、链接、代码、表格、公示、媒体链接等 Markdown 元素。
- 最多提出 30 个问题。
`,fixedText:`请按以下格式整理学习成果:
<Context>
文本
</Context>
Q1: 问题。
A1: 答案。
Q2:
A2:

------

我们开始吧!

<Context>
{{text}}
<Context/>
`},r=`你可以从 <对话记录></对话记录> 中提取指定 JSON 信息，你仅需返回 JSON 字符串，无需回答问题。
<提取要求>
{{description}}
</提取要求>

<字段说明>
1. 下面的 JSON 字符串均按照 JSON Schema 的规则描述。
2. key 代表字段名；description 代表字段的描述；enum 是可选值，代表可选的 value。
3. 如果没有可提取的内容，忽略该字段。
4. 本次需提取的JSON Schema：{{json}}
</字段说明>

<对话记录>
{{text}}
</对话记录>
`,o=`请帮我执行一个“问题分类”任务，将问题分类为以下几种类型之一：

"""
{{typeList}}
"""

## 背景知识
{{systemPrompt}}

## 对话记录
{{history}}

## 开始任务

现在，我们开始分类，我会给你一个"问题"，请结合背景知识和对话记录，将问题分类到对应的类型中，并返回类型ID。

问题："{{question}}"
类型ID=
`},49877:(e,t,a)=>{"use strict";a.d(t,{RO:()=>l,nN:()=>d,vC:()=>i,vG:()=>u,z2:()=>c});var n=a(88068),r=a(93556);let o={[r.NZ.System]:n.LG.System,[r.NZ.User]:n.LG.Human,[r.NZ.Assistant]:n.LG.AI,[r.NZ.Function]:n.LG.AI,[r.NZ.Tool]:n.LG.AI},s=e=>1===e.length&&"text"===e[0].type?e[0].text:e,i=({messages:e,reserveId:t,reserveTool:a=!1})=>{let o=[];return e.forEach(e=>{let i=t?e.dataId:void 0;if(e.obj===n.LG.Human){let t=e.value.map(e=>e.type===n.Dl.text?{type:"text",text:e.text?.content||""}:"file"===e.type&&e.file?.type===n.bM.image?{type:"image_url",image_url:{url:e.file?.url||""}}:void 0).filter(Boolean);o.push({dataId:i,role:r.NZ.User,content:s(t)})}else if(e.obj===n.LG.System){let t=e.value?.[0]?.text?.content;t&&o.push({dataId:i,role:r.NZ.System,content:t})}else e.value.forEach(e=>{if(e.type===n.Dl.tool&&e.tools&&a){let t=[],a=[];e.tools.forEach(e=>{t.push({id:e.id,type:"function",function:{name:e.functionName,arguments:e.params}}),a.push({tool_call_id:e.id,role:r.NZ.Tool,name:e.functionName,content:e.response})}),o=o.concat({dataId:i,role:r.NZ.Assistant,tool_calls:t}).concat(a)}else e.text&&o.push({dataId:i,role:r.NZ.Assistant,content:e.text.content})})}),o},l=(e,t=!0)=>e.map(a=>{let s=[],i=o[a.role];if(i===n.LG.System&&a.role===r.NZ.System)s.push({type:n.Dl.text,text:{content:a.content}});else if(i===n.LG.Human&&a.role===r.NZ.User)"string"==typeof a.content?s.push({type:n.Dl.text,text:{content:a.content}}):Array.isArray(a.content)&&a.content.forEach(e=>{"text"===e.type?s.push({type:n.Dl.text,text:{content:e.text}}):"image_url"===e.type&&s.push({type:"file",file:{type:n.bM.image,name:"",url:e.image_url.url}})});else if(i===n.LG.AI&&a.role===r.NZ.Assistant){if(a.content&&"string"==typeof a.content)s.push({type:n.Dl.text,text:{content:a.content}});else if(a.tool_calls&&t){let t=a.tool_calls;s.push({type:n.Dl.tool,tools:t.map(t=>{let a=e.find(e=>e.role===r.NZ.Tool&&e.tool_call_id===t.id)?.content||"";return a="string"==typeof a?a:JSON.stringify(a),{id:t.id,toolName:t.toolName||"",toolAvatar:t.toolAvatar||"",functionName:t.function.name,params:t.function.arguments,response:a}})})}else if(a.function_call&&t){let t=a.function_call,o=e.find(e=>e.role===r.NZ.Function&&e.name===a.function_call?.name);o&&s.push({type:n.Dl.tool,tools:[{id:t.id||"",toolName:t.toolName||"",toolAvatar:t.toolAvatar||"",functionName:t.name,params:t.arguments,response:o.content||""}]})}}return{dataId:a.dataId,obj:i,value:s}}).filter(e=>e.value.length>0),c=e=>{let t={files:[],text:""};return e.forEach(e=>{"file"===e.type&&e.file?t.files?.push(e.file):e.text&&(t.text+=e.text.content)}),t},d=e=>{let t=[];return e.files&&e.files.forEach(e=>{t.push({type:n.Dl.file,file:e})}),e.text&&t.push({type:n.Dl.text,text:{content:e.text}}),t},u=e=>e?[{obj:n.LG.System,value:[{type:n.Dl.text,text:{content:e}}]}]:[]},84569:(e,t,a)=>{"use strict";a.d(t,{ZA:()=>o,cj:()=>s,pB:()=>i});var n=a(81413),r=a(88068);let o=(e,t="新对话")=>{let a=e?.value.find(e=>e.type===r.Dl.text);return a?.text?.content?a.text.content.slice(0,20):t},s=e=>e.map((t,a)=>{if(t.obj===r.LG.System||a>=e.length-2)return{obj:t.obj,value:t.value?.[0]?.text?.content||""};let n=t.value.map(e=>{if(e.text?.content){let t=e.text.content.length>20?`${e.text.content.slice(0,20)}...`:e.text.content;return t}return""}).filter(Boolean).join("\n");return{obj:t.obj,value:n}}),i=({flowResponses:e=[]})=>{let t=["quoteList","moduleType"],a=[n.Jm.pluginModule,n.Jm.datasetSearchNode,n.Jm.tools];return e.filter(e=>a.includes(e.moduleType)).map(e=>{let a={};for(let n in e)"toolDetail"===n||"pluginDetail"===n?a[n]=i({flowResponses:e[n]}):t.includes(n)&&(a[n]=e[n]);return a})}},89645:(e,t,a)=>{"use strict";var n,r,o,s,i,l,c,d;a.d(t,{$8:()=>r,Ls:()=>m,Lz:()=>s,Nz:()=>f,Qw:()=>y,Ug:()=>o,V0:()=>p,ds:()=>d,g0:()=>l,iR:()=>i,ie:()=>n,o5:()=>u,wq:()=>c}),function(e){e.folder="folder",e.dataset="dataset",e.websiteDataset="websiteDataset"}(n||(n={}));let u={[n.folder]:{icon:"common/folderFill",label:"core.dataset.Folder Dataset",collectionLabel:"common.Folder"},[n.dataset]:{icon:"core/dataset/commonDataset",label:"core.dataset.Common Dataset",collectionLabel:"common.File"},[n.websiteDataset]:{icon:"core/dataset/websiteDataset",label:"core.dataset.Website Dataset",collectionLabel:"common.Website"}};!function(e){e.active="active",e.syncing="syncing"}(r||(r={}));let m={[r.active]:{label:"core.dataset.status.active"},[r.syncing]:{label:"core.dataset.status.syncing"}};!function(e){e.folder="folder",e.file="file",e.link="link",e.virtual="virtual"}(o||(o={}));let p={[o.folder]:{name:"core.dataset.folder"},[o.file]:{name:"core.dataset.file"},[o.link]:{name:"core.dataset.link"},[o.virtual]:{name:"core.dataset.Manual collection"}};(function(e){e.sameRaw="sameRaw",e.success="success"})(s||(s={})),s.sameRaw,s.success,function(e){e.fileLocal="fileLocal",e.fileLink="fileLink",e.fileCustom="fileCustom",e.csvTable="csvTable"}(i||(i={})),function(e){e.chunk="chunk",e.auto="auto",e.qa="qa"}(l||(l={}));let y={[l.chunk]:{label:"core.dataset.training.Chunk mode",tooltip:"core.dataset.import.Chunk Split Tip",openSource:!0},[l.auto]:{label:"core.dataset.training.Auto mode",tooltip:"core.dataset.training.Auto mode Tip",openSource:!1},[l.qa]:{label:"core.dataset.training.QA mode",tooltip:"core.dataset.import.QA Import Tip",openSource:!0}};!function(e){e.embedding="embedding",e.fullTextRecall="fullTextRecall",e.mixedRecall="mixedRecall"}(c||(c={}));let f={[c.embedding]:{icon:"core/dataset/modeEmbedding",title:"core.dataset.search.mode.embedding",desc:"core.dataset.search.mode.embedding desc",value:c.embedding},[c.fullTextRecall]:{icon:"core/dataset/fullTextRecall",title:"core.dataset.search.mode.fullTextRecall",desc:"core.dataset.search.mode.fullTextRecall desc",value:c.fullTextRecall},[c.mixedRecall]:{icon:"core/dataset/mixedRecall",title:"core.dataset.search.mode.mixedRecall",desc:"core.dataset.search.mode.mixedRecall desc",value:c.mixedRecall}};(function(e){e.embedding="embedding",e.fullText="fullText",e.reRank="reRank",e.rrf="rrf"})(d||(d={})),d.embedding,d.fullText,d.reRank,d.rrf},18605:(e,t,a)=>{"use strict";a.d(t,{o:()=>r});var n=a(89645);let r=e=>{if(0===(e=e.filter(e=>e.list.length>0)).length)return[];if(1===e.length)return e[0].list;let t=new Map;e.forEach(e=>{let a=e.k;e.list.forEach((e,n)=>{let r=1/(a+(n+1)),o=t.get(e.id);if(o){let a=[...o.score];for(let t of e.score){let e=a.find(e=>e.type===t.type);e?e.value=Math.max(e.value,t.value):a.push(t)}t.set(e.id,{...o,score:a,rrfScore:o.rrfScore+r})}else t.set(e.id,{...e,rrfScore:r})})});let a=Array.from(t.values()),r=a.sort((e,t)=>t.rrfScore-e.rrfScore);return r.map((e,t)=>{let a=e.score.find(e=>e.type===n.ds.rrf);return a?(a.value=e.rrfScore,a.index=t):e.score.push({type:n.ds.rrf,value:e.rrfScore,index:t}),delete e.rrfScore,e})}},32259:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Db:()=>i,_B:()=>l});var r=a(89645);a(18824);var o=a(935),s=e([o]);function i(e){let{q:t="",a,dataId:n}=e||{},r=`${t}
${a}`.trim();return{defaultIndex:!0,text:a?r:t,dataId:n}}o=(s.then?(await s)():s)[0];let l=(e,t)=>e===r.g0.qa?20*t.length:e===r.g0.auto?5*t.length:t.length;n()}catch(e){n(e)}})},85686:(e,t,a)=>{"use strict";var n,r;a.d(t,{AQ:()=>n,C9:()=>r,_H:()=>o}),function(e){e.folder="folder",e.custom="custom",e.http="http"}(n||(n={}));let o={[n.folder]:{label:"文件夹",icon:"file/fill/folder"},[n.custom]:{label:"自定义",icon:"common/custom"},[n.http]:{label:"HTTP",icon:"common/http"}};!function(e){e.personal="personal",e.community="community",e.commercial="commercial"}(r||(r={}))},73945:(e,t,a)=>{"use strict";a.d(t,{$q:()=>p,I2:()=>i,Zs:()=>s,_Y:()=>c,q5:()=>m,u6:()=>u,v_:()=>l});var n=a(93556),r=a(88844),o=a(81413);let s=e=>e?.map(e=>({...e,status:"waiting"}))||[],i=e=>{let t=[o.Jm.systemConfig,o.Jm.workflowStart,o.Jm.pluginInput];return e.filter(e=>t.includes(e.flowNodeType)).map(e=>e.nodeId)},l=(e,t)=>e.map(e=>({nodeId:e.nodeId,name:e.name,avatar:e.avatar,intro:e.intro,flowNodeType:e.flowNodeType,showStatus:e.showStatus,isEntry:t.includes(e.nodeId),inputs:e.inputs,outputs:e.outputs,pluginId:e.pluginId}))||[],c=e=>e.filter(e=>e.sourceHandle!==r.YQ.selectedTools&&e.targetHandle!==r.YQ.selectedTools),d=({edges:e,allEdges:t,currentNode:a})=>{let n=[],r=[];return e.forEach(e=>{let o=e=>{let n=t.find(t=>t.target===e.source);return!!n&&(n.source===a.nodeId||o(n))};o(e)?r.push(e):n.push(e)}),{commonEdges:n,recursiveEdges:r}},u=({node:e,runtimeEdges:t})=>{let a=c(t).filter(t=>t.target===e.nodeId);if(0===a.length)return"run";let{commonEdges:n,recursiveEdges:r}=d({edges:a,allEdges:t,currentNode:e});return n.every(e=>"skipped"===e.status)||r.length>0&&r.every(e=>"skipped"===e.status)?"skip":n.every(e=>"waiting"!==e.status)||r.length>0&&r.every(e=>"waiting"!==e.status)?"run":"wait"},m=({value:e,nodes:t,variables:a})=>{if(!Array.isArray(e)||2!==e.length||"string"!=typeof e[0]||"string"!=typeof e[1])return e;let n=e[0],o=e[1];if(n===r._Z&&o)return a[o];let s=t.find(e=>e.nodeId===n);if(!s)return;let i=s.outputs.find(e=>e.id===o)?.value;return i},p=({text:e,model:t="",finish_reason:a=null,extraData:r={}})=>JSON.stringify({...r,id:"",object:"",created:0,model:t,choices:[{delta:null===e?{}:{role:n.NZ.Assistant,content:e},index:0,finish_reason:a}]})},46498:(e,t,a)=>{"use strict";a.d(t,{b:()=>n});let n=(e,t,a,n)=>({top:e,right:t,bottom:a,left:n})},27378:(e,t,a)=>{"use strict";a.d(t,{OI:()=>l,h_:()=>u,xH:()=>s,yx:()=>i});var n=a(81413),r=a(88844),o=a(68774);let s=(e,t,a)=>`${e}-${t}-${a}`,i=e=>e.find(e=>e.flowNodeType===n.Jm.systemConfig),l=e=>{let t=e?.inputs?.find(e=>e.key===r.YS.welcomeText)?.value||"",a=e?.inputs.find(e=>e.key===r.YS.variables)?.value||[],n=!!e?.inputs?.find(e=>e.key===r.YS.questionGuide)?.value,s=e?.inputs?.find(e=>e.key===r.YS.tts)?.value||{type:"web"},i=e?.inputs?.find(e=>e.key===r.YS.whisper)?.value||o.J2,l=e?.inputs?.find(e=>e.key===r.YS.scheduleTrigger)?.value??null;return{welcomeText:t,variableModules:a,questionGuide:n,ttsConfig:s,whisperConfig:i,scheduledTriggerConfig:l}},c=e=>{if(void 0!==e.value||!e.valueType)return e.value;let t={[r.o7.boolean]:!1,[r.o7.number]:0,[r.o7.string]:""};return t[e.valueType]},d=e=>({}),u=e=>{let t=e.find(e=>e.flowNodeType===n.Jm.pluginInput),a=e.find(e=>e.flowNodeType===n.Jm.pluginOutput);return{inputs:t?t.inputs.map(e=>({...e,...d(e),value:c(e),canEdit:!1})):[],outputs:a?[...a.inputs.map(e=>({id:e.key,type:n.YG.static,key:e.key,valueType:e.valueType,label:e.label||e.key,description:e.description}))]:[]}}},68930:(e,t,a)=>{"use strict";var n;a.d(t,{V:()=>n}),function(e){e.common="common",e.important="important",e.emergency="emergency"}(n||(n={})),n.common,n.important,n.emergency},82702:(e,t,a)=>{"use strict";a.d(t,{r:()=>n});let n=1e5},29384:(e,t,a)=>{"use strict";var n,r,o,s;a.d(t,{$X:()=>l,F8:()=>o,Yn:()=>s,cc:()=>n,gj:()=>d,jh:()=>c,lo:()=>r,rD:()=>i}),function(e){e.standard="standard",e.extraDatasetSize="extraDatasetSize",e.extraPoints="extraPoints"}(n||(n={}));let i={[n.standard]:{label:"support.wallet.subscription.type.standard",icon:"support/account/plans"},[n.extraDatasetSize]:{label:"support.wallet.subscription.type.extraDatasetSize",icon:"core/dataset/datasetLight"},[n.extraPoints]:{label:"support.wallet.subscription.type.extraPoints",icon:"core/chat/chatLight"}};!function(e){e.active="active",e.expired="expired"}(r||(r={}));let l={[r.active]:{label:"support.wallet.subscription.status.active"},[r.expired]:{label:"support.wallet.subscription.status.canceled"}};!function(e){e.month="month",e.year="year"}(o||(o={}));let c={[o.month]:{label:"support.wallet.subscription.mode.Month",durationMonth:1},[o.year]:{label:"support.wallet.subscription.mode.Year",durationMonth:12}};!function(e){e.free="free",e.experience="experience",e.team="team",e.enterprise="enterprise",e.custom="custom"}(s||(s={}));let d={[s.free]:{label:"support.wallet.subscription.standardSubLevel.free",desc:"support.wallet.subscription.standardSubLevel.free desc"},[s.experience]:{label:"support.wallet.subscription.standardSubLevel.experience",desc:""},[s.team]:{label:"support.wallet.subscription.standardSubLevel.team",desc:""},[s.enterprise]:{label:"support.wallet.subscription.standardSubLevel.enterprise",desc:""},[s.custom]:{label:"support.wallet.subscription.standardSubLevel.custom",desc:""}}},97287:(e,t,a)=>{"use strict";var n;a.d(t,{u:()=>n,z:()=>r}),function(e){e.fastgpt="fastgpt",e.api="api",e.shareLink="shareLink",e.training="training"}(n||(n={}));let r={[n.fastgpt]:{label:"在线使用"},[n.api]:{label:"Api"},[n.shareLink]:{label:"免登录链接"},[n.training]:{label:"dataset.Training Name"}}},19781:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{m:()=>s});var r=a(17405),o=e([r]);r=(o.then?(await o)():o)[0];let s=e=>(0,r.a4)("/common/censor/text_baidu",e).then(e=>{if(e?.code===5e3)return Promise.reject(e)}).catch(e=>e?.code===5e3?Promise.reject(e.message):Promise.resolve(""));n()}catch(e){n(e)}})},33746:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{a4:()=>i});var r=a(47676),o=a(99648),s=e([o]);o=(s.then?(await s)():s)[0];let l=o.default.create({timeout:6e4,headers:{"content-type":"application/json","Cache-Control":"no-cache"}});function i(e,t={},a={}){return function(e,t,a,n){for(let e in t)(null===t[e]||void 0===t[e])&&delete t[e];return l.request({baseURL:`http://${r.wm}`,url:e,method:n,data:["POST","PUT"].includes(n)?t:null,params:["POST","PUT"].includes(n)?null:t,...a}).then(e=>{var t;return t=e.data,void 0===t?(console.log("error->",t,"data is empty"),Promise.reject("服务器异常")):t?.code&&(t.code<200||t.code>=400)?Promise.reject(t):t}).catch(e=>e?"string"==typeof e?Promise.reject({message:e}):e?.response?.data?Promise.reject(e?.response?.data):Promise.reject(e):Promise.reject({message:"未知错误"}))}(e,t,a,"POST")}l.interceptors.request.use(function(e){return e},e=>Promise.reject(e)),l.interceptors.response.use(function(e){return e},e=>Promise.reject(e)),n()}catch(e){n(e)}})},62202:(e,t,a)=>{"use strict";a.d(t,{K:()=>c});var n=a(48079);let{Schema:r,model:o,models:s}=n.connectionMongo,i="buffer.rawText",l=new r({sourceId:{type:String,required:!0},rawText:{type:String,default:""},createTime:{type:Date,default:()=>new Date},metadata:Object});try{l.index({sourceId:1}),l.index({createTime:1},{expireAfterSeconds:1200})}catch(e){console.log(e)}let c=s[i]||o(i,l);c.syncIndexes()},57749:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{$B:()=>I,DW:()=>g,Tf:()=>b,cT:()=>w,hh:()=>v,yC:()=>x});var r=a(48079),o=a(73292),s=a.n(o),i=a(57147),l=a.n(i),c=a(60110),d=a(98237),u=a(95618),m=a(62202),p=a(37031),y=a(12781),f=e([p]);function g(e){return c.R,r.connectionMongo.connection.db.collection(`${e}.files`)}function h(e){return new r.connectionMongo.mongo.GridFSBucket(r.connectionMongo.connection.db,{bucketName:e})}async function w({bucketName:e,teamId:t,tmbId:a,path:n,filename:r,contentType:o,metadata:i={}}){if(!n)return Promise.reject("filePath is empty");if(!r)return Promise.reject("filename is empty");let c=await s().stat(n);if(!c.isFile())return Promise.reject(`${n} is not a file`);i.teamId=t,i.tmbId=a;let d=h(e),u=d.openUploadStream(r,{metadata:i,contentType:o});return await new Promise((e,t)=>{l().createReadStream(n).pipe(u).on("finish",e).on("error",t)}),String(u.id)}async function b({bucketName:e,fileId:t}){let a=g(e),n=await a.findOne({_id:new r.Types.ObjectId(t)});return n||void 0}async function v({bucketName:e,fileIdList:t,retry:a=3}){try{let a=h(e);await Promise.all(t.map(e=>a.delete(new r.Types.ObjectId(e))))}catch(n){if(a>0)return v({bucketName:e,fileIdList:t,retry:a-1})}}async function I({bucketName:e,fileId:t}){let a=h(e),n=a.openDownloadStream(new r.Types.ObjectId(t)),o=n.pipe(new y.PassThrough),s=await new Promise((e,t)=>{let a=Buffer.from([]);n.on("data",t=>{a.length<20&&(a=Buffer.concat([a,t])),a.length>=20&&e(a)}),n.on("end",()=>{e(a)}),n.on("error",e=>{t(e)})}),i=(0,d.K)(s);return{fileStream:o,encoding:i}}p=(f.then?(await f)():f)[0];let x=async({teamId:e,bucketName:t,fileId:a,csvFormat:n=!1})=>{let r=await m.K.findOne({sourceId:a}).lean();if(r)return{rawText:r.rawText,filename:r.metadata?.filename||""};let[o,{encoding:s,fileStream:i}]=await Promise.all([b({bucketName:t,fileId:a}),I({bucketName:t,fileId:a})]);if(!o)return Promise.reject(u.P.fileNotFound);let l=o?.filename?.split(".")?.pop()?.toLowerCase()||"",c=await new Promise((e,t)=>{let a=Buffer.from([]);i.on("data",e=>{a=Buffer.concat([a,e])}),i.on("end",()=>{e(a)}),i.on("error",e=>{t(e)})}),{rawText:d}=await (0,p.rL)({extension:l,csvFormat:n,teamId:e,buffer:c,encoding:s,metadata:{relatedId:a}});return d.trim()&&m.K.create({sourceId:a,rawText:d,metadata:{filename:o.filename}}),{rawText:d,filename:o.filename}};n()}catch(e){n(e)}})},60110:(e,t,a)=>{"use strict";a.d(t,{R:()=>l});var n=a(48079);let{Schema:r,model:o,models:s}=n.connectionMongo,i=new r({});try{i.index({"metadata.teamId":1}),i.index({"metadata.uploadDate":-1})}catch(e){console.log(e)}let l=s["dataset.files"]||o("dataset.files",i);l.syncIndexes()},89642:(e,t,a)=>{"use strict";a.d(t,{EY:()=>s,Rf:()=>i,aj:()=>o});var n=a(11730),r=a(39509);async function o({type:e,base64Img:t,teamId:a,expiredTime:o,metadata:s,shareId:i}){if(t.length>12582912)return Promise.reject("Image too large");let l=t.split(",")[1],c=Buffer.from(l,"base64"),{_id:d}=await r.W.create({type:e,teamId:a,binary:c,expiredTime:o,metadata:s,shareId:i});return`${n.AJ}${String(d)}`}async function s({id:e}){let t=await r.W.findById(e);return t?t?.binary:Promise.reject("Image not found")}async function i({teamId:e,relateIds:t,session:a}){if(0!==t.length)return r.W.deleteMany({teamId:e,"metadata.relatedId":{$in:t.map(e=>String(e))}},{session:a})}},39509:(e,t,a)=>{"use strict";a.d(t,{W:()=>d});var n=a(3036),r=a(48079),o=a(11730);let{Schema:s,model:i,models:l}=r.connectionMongo,c=new s({teamId:{type:s.Types.ObjectId,ref:n.NG,required:!0},createTime:{type:Date,default:()=>new Date},expiredTime:{type:Date},binary:{type:Buffer},type:{type:String,enum:Object.keys(o.tY),required:!0},metadata:{type:Object}});try{c.index({expiredTime:1},{expireAfterSeconds:60}),c.index({type:1}),c.index({createTime:1}),c.index({teamId:1,"metadata.relatedId":1})}catch(e){console.log(e)}let d=l.image||i("image",c);d.syncIndexes()},37031:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{c$:()=>p,rL:()=>m});var r=a(63092),o=a(89642),s=a(11730),i=a(97309),l=a.n(i),c=a(72219),d=e([r]);r=(d.then?(await d)():d)[0];let u=({teamId:e,md:t,metadata:a})=>(0,r._U)({rawText:t,uploadImgController:t=>(0,o.aj)({type:s.XJ.collectionImage,base64Img:t,teamId:e,metadata:a,expiredTime:l()(new Date,2)})}),m=async({extension:e,csvFormat:t,teamId:a,buffer:n,encoding:r,metadata:o})=>{let s=await (0,c.YX)(c.ww.readFile,{extension:e,csvFormat:t,encoding:r,buffer:n});return["md","html","docx"].includes(e)&&(s.rawText=await u({teamId:a,md:s.rawText,metadata:o})),s},p=async e=>{let t=await (0,c.YX)(c.ww.htmlStr2Md,{html:e||""});return(0,r.aB)(t)};n()}catch(e){n(e)}})},17639:(e,t,a)=>{"use strict";a.d(t,{Gg:()=>l,Ok:()=>c,yg:()=>d});var n=a(32170),r=a(57147),o=a.n(r),s=a(71017),i=a.n(s);let l=e=>{e.forEach(e=>{o().unlink(e,e=>{})})},c=e=>{let t="image/jpeg";if("string"!=typeof e||0===e.length)return t;let a=e.charAt(0);return({"/":"image/jpeg",i:"image/png",R:"image/gif",U:"image/webp",Q:"image/bmp"})[a]||t},d=()=>{if(!n.y)return;let e="/tmp";o().readdir(e,(t,a)=>{if(!t)for(let t of a){if("v8-compile-cache-0"===t)continue;let a=i().join(e,t);o().stat(a,(e,t)=>{!e&&Date.now()-t.mtime.getTime()>72e5&&o().unlink(a,e=>{e||console.log(`Deleted temp file: ${a}`)})})}})}},98312:(e,t,a)=>{"use strict";a.d(t,{Q:()=>r});var n=a(48079);async function r({beforeHook:e,afterHook:t}){if(!global.mongodb){global.mongodb=n.default,e&&await e(),console.log("mongo start connect");try{n.default.set("strictQuery",!0);let e=Math.max(30,Number(process.env.DB_MAX_LINK||20));await n.default.connect(process.env.MONGODB_URI,{bufferCommands:!0,maxConnecting:e,maxPoolSize:e,minPoolSize:20,connectTimeoutMS:6e4,waitQueueTimeoutMS:6e4,socketTimeoutMS:6e4,maxIdleTimeMS:3e5,retryWrites:!0,retryReads:!0}),n.default.connection.on("error",e=>{console.log("mongo error",e),global.mongodb?.disconnect(),global.mongodb=void 0}),console.log("mongo connected"),t&&await t()}catch(e){global.mongodb.disconnect(),console.log("error->","mongo connect error",e),global.mongodb=void 0}}}},5286:(e,t,a)=>{"use strict";a.d(t,{w:()=>r});var n=a(48079);let r=async e=>{let t=await n.connectionMongo.startSession();t.startTransaction();try{let a=await e(t);return await t.commitTransaction(),t.endSession(),a}catch(e){return console.log(e),await t.abortTransaction(),t.endSession(),Promise.reject(e)}}},61292:(e,t,a)=>{"use strict";a.d(t,{P:()=>o});var n=a(83542);let r=new Set(["--","?","“","”","》","－－","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","ain't","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","aren't","around","as","a's","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","came","can","cannot","cant","can't","cause","causes","certain","certainly","changes","clearly","c'mon","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldn't","course","c's","currently","definitely","described","despite","did","didn't","different","do","does","doesn't","doing","done","don't","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadn't","happens","hardly","has","hasn't","have","haven't","having","he","hello","help","hence","her","here","hereafter","hereby","herein","here's","hereupon","hers","herself","he's","hi","him","himself","his","hither","hopefully","how","howbeit","however","i'd","ie","if","ignored","i'll","i'm","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isn't","it","it'd","it'll","its","it's","itself","i've","just","keep","keeps","kept","know","known","knows","last","lately","later","latter","latterly","least","less","lest","let","let's","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","novel","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldn't","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","take","taken","tell","tends","th","than","thank","thanks","thanx","that","thats","that's","the","their","theirs","them","themselves","then","thence","there","thereafter","thereby","therefore","therein","theres","there's","thereupon","these","they","they'd","they'll","they're","they've","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","t's","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasn't","way","we","we'd","welcome","well","we'll","went","were","we're","weren't","we've","what","whatever","what's","when","whence","whenever","where","whereafter","whereas","whereby","wherein","where's","whereupon","wherever","whether","which","while","whither","who","whoever","whole","whom","who's","whose","why","will","willing","wish","with","within","without","wonder","won't","would","wouldn't","yes","yet","you","you'd","you'll","your","you're","yours","yourself","yourselves","you've","zero","zt","ZT","zz","ZZ","一","一下","一些","一切","一则","一天","一定","一方面","一旦","一时","一来","一样","一次","一片","一直","一致","一般","一起","一边","一面","万一","上下","上升","上去","上来","上述","上面","下列","下去","下来","下面","不一","不久","不仅","不会","不但","不光","不单","不变","不只","不可","不同","不够","不如","不得","不怕","不惟","不成","不拘","不敢","不断","不是","不比","不然","不特","不独","不管","不能","不要","不论","不足","不过","不问","与","与其","与否","与此同时","专门","且","两者","严格","严重","个","个人","个别","中小","中间","丰富","临","为","为主","为了","为什么","为什麽","为何","为着","主张","主要","举行","乃","乃至","么","之","之一","之前","之后","之後","之所以","之类","乌乎","乎","乘","也","也好","也是","也罢","了","了解","争取","于","于是","于是乎","云云","互相","产生","人们","人家","什么","什么样","什麽","今后","今天","今年","今後","仍然","从","从事","从而","他","他人","他们","他的","代替","以","以上","以下","以为","以便","以免","以前","以及","以后","以外","以後","以来","以至","以至于","以致","们","任","任何","任凭","任务","企图","伟大","似乎","似的","但","但是","何","何况","何处","何时","作为","你","你们","你的","使得","使用","例如","依","依照","依靠","促进","保持","俺","俺们","倘","倘使","倘或","倘然","倘若","假使","假如","假若","做到","像","允许","充分","先后","先後","先生","全部","全面","兮","共同","关于","其","其一","其中","其二","其他","其余","其它","其实","其次","具体","具体地说","具体说来","具有","再者","再说","冒","冲","决定","况且","准备","几","几乎","几时","凭","凭借","出去","出来","出现","分别","则","别","别的","别说","到","前后","前者","前进","前面","加之","加以","加入","加强","十分","即","即令","即使","即便","即或","即若","却不","原来","又","及","及其","及时","及至","双方","反之","反应","反映","反过来","反过来说","取得","受到","变成","另","另一方面","另外","只是","只有","只要","只限","叫","叫做","召开","叮咚","可","可以","可是","可能","可见","各","各个","各人","各位","各地","各种","各级","各自","合理","同","同一","同时","同样","后来","后面","向","向着","吓","吗","否则","吧","吧哒","吱","呀","呃","呕","呗","呜","呜呼","呢","周围","呵","呸","呼哧","咋","和","咚","咦","咱","咱们","咳","哇","哈","哈哈","哉","哎","哎呀","哎哟","哗","哟","哦","哩","哪","哪个","哪些","哪儿","哪天","哪年","哪怕","哪样","哪边","哪里","哼","哼唷","唉","啊","啐","啥","啦","啪达","喂","喏","喔唷","嗡嗡","嗬","嗯","嗳","嘎","嘎登","嘘","嘛","嘻","嘿","因","因为","因此","因而","固然","在","在下","地","坚决","坚持","基本","处理","复杂","多","多少","多数","多次","大力","大多数","大大","大家","大批","大约","大量","失去","她","她们","她的","好的","好象","如","如上所述","如下","如何","如其","如果","如此","如若","存在","宁","宁可","宁愿","宁肯","它","它们","它们的","它的","安全","完全","完成","实现","实际","宣布","容易","密切","对","对于","对应","将","少数","尔后","尚且","尤其","就","就是","就是说","尽","尽管","属于","岂但","左右","巨大","巩固","己","已经","帮助","常常","并","并不","并不是","并且","并没有","广大","广泛","应当","应用","应该","开外","开始","开展","引起","强烈","强调","归","当","当前","当时","当然","当着","形成","彻底","彼","彼此","往","往往","待","後来","後面","得","得出","得到","心里","必然","必要","必须","怎","怎么","怎么办","怎么样","怎样","怎麽","总之","总是","总的来看","总的来说","总的说来","总结","总而言之","恰恰相反","您","意思","愿意","慢说","成为","我","我们","我的","或","或是","或者","战斗","所","所以","所有","所谓","打","扩大","把","抑或","拿","按","按照","换句话说","换言之","据","掌握","接着","接著","故","故此","整个","方便","方面","旁人","无宁","无法","无论","既","既是","既然","时候","明显","明确","是","是否","是的","显然","显著","普通","普遍","更加","曾经","替","最后","最大","最好","最後","最近","最高","有","有些","有关","有利","有力","有所","有效","有时","有点","有的","有着","有著","望","朝","朝着","本","本着","来","来着","极了","构成","果然","果真","某","某个","某些","根据","根本","欢迎","正在","正如","正常","此","此外","此时","此间","毋宁","每","每个","每天","每年","每当","比","比如","比方","比较","毫不","没有","沿","沿着","注意","深入","清楚","满足","漫说","焉","然则","然后","然後","然而","照","照着","特别是","特殊","特点","现代","现在","甚么","甚而","甚至","用","由","由于","由此可见","的","的话","目前","直到","直接","相似","相信","相反","相同","相对","相对而言","相应","相当","相等","省得","看出","看到","看来","看看","看见","真是","真正","着","着呢","矣","知道","确定","离","积极","移动","突出","突然","立即","第","等","等等","管","紧接着","纵","纵令","纵使","纵然","练习","组成","经","经常","经过","结合","结果","给","绝对","继续","继而","维持","综上所述","罢了","考虑","者","而","而且","而况","而外","而已","而是","而言","联系","能","能否","能够","腾","自","自个儿","自从","自各儿","自家","自己","自身","至","至于","良好","若","若是","若非","范围","莫若","获得","虽","虽则","虽然","虽说","行为","行动","表明","表示","被","要","要不","要不是","要不然","要么","要是","要求","规定","觉得","认为","认真","认识","让","许多","论","设使","设若","该","说明","诸位","谁","谁知","赶","起","起来","起见","趁","趁着","越是","跟","转动","转变","转贴","较","较之","边","达到","迅速","过","过去","过来","运用","还是","还有","这","这个","这么","这么些","这么样","这么点儿","这些","这会儿","这儿","这就是说","这时","这样","这点","这种","这边","这里","这麽","进入","进步","进而","进行","连","连同","适应","适当","适用","逐步","逐渐","通常","通过","造成","遇到","遭到","避免","那","那个","那么","那么些","那么样","那些","那会儿","那儿","那时","那样","那边","那里","那麽","部分","鄙人","采取","里面","重大","重新","重要","鉴于","问题","防止","阿","附近","限制","除","除了","除此之外","除非","随","随着","随著","集中","需要","非但","非常","非徒","靠","顺","顺着","首先","高兴","是不是","说说"," ",["about","after","all","also","am","an","and","another","any","are","as","at","be","because","been","before","being","between","both","but","by","came","can","come","could","did","do","each","for","from","get","got","has","had","he","have","her","here","him","himself","his","how","if","in","into","is","it","like","make","many","me","might","more","most","much","must","my","never","now","of","on","only","or","other","our","out","over","said","same","should","since","some","still","such","take","than","that","the","their","them","then","there","these","they","this","those","through","to","too","under","up","very","was","way","we","well","were","what","where","which","while","who","with","would","you","your","a","i"]]);function o({text:e}){let t=(0,n.cut)(e,!0);return t.map(e=>e.replace(/[\u3000-\u303f\uff00-\uffef]/g,"").trim()).filter(e=>e&&!r.has(e)).join(" ")||""}},7110:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{BM:()=>m,SG:()=>u,et:()=>d});var r=a(49877),o=a(72219),s=a(935),i=a(7161),l=e([s]);s=(l.then?(await l)():l)[0];let c=()=>{if(global.tiktokenWorker)return global.tiktokenWorker;let e=(0,o.Sl)(o.ww.countGptMessagesTokens);return e.on("message",({id:e,data:t})=>{let a=global.tiktokenWorker?.callbackMap?.[e];a&&(a?.(t),delete global.tiktokenWorker.callbackMap[e])}),global.tiktokenWorker={worker:e,callbackMap:{}},global.tiktokenWorker},d=(e,t,a)=>new Promise(n=>{let r=Date.now(),{worker:o,callbackMap:l}=c(),d=(0,s.Cj)(),u=setTimeout(()=>{n(0),delete l[d]},300);l[d]=e=>{n(e),clearTimeout(u),i.B.info(`Count token time: ${Date.now()-r}, token: ${e}`),console.log(Object.keys(global.tiktokenWorker.callbackMap))},o.postMessage({id:d,messages:e,tools:t,functionCall:a})}),u=e=>{let t=(0,r.vC)({messages:e,reserveId:!0});return d(t)},m=async(e="",t="")=>{let a=await d([{role:t,content:e}]);return a};n()}catch(e){n(e)}})},94459:(e,t,a)=>{"use strict";a.d(t,{f:()=>s});var n=a(68150),r=a(83497),o=a(32170);let s=async()=>{if(!o.v)return{};let e=await r.E.findOne({type:n.H.fastgpt}).sort({createTime:-1}),t=e?.value||{};return t}},83497:(e,t,a)=>{"use strict";a.d(t,{E:()=>d});var n=a(48079),r=a(68150);let{Schema:o,model:s,models:i}=n.connectionMongo,l="systemConfigs",c=new o({type:{type:String,required:!0,enum:Object.keys(r._)},value:{type:Object,required:!0},createTime:{type:Date,default:()=>new Date}});try{c.index({type:1})}catch(e){console.log(e)}let d=i[l]||s(l,c);d.syncIndexes()},74035:(e,t,a)=>{"use strict";a.d(t,{b:()=>o});var n=a(35647),r=a.n(n);let o=(e,t)=>r().schedule(e,t)},9819:(e,t,a)=>{"use strict";var n;a.d(t,{Y:()=>n,p:()=>r}),function(e){e.checkInValidDatasetFiles="checkInValidDatasetFiles",e.checkInvalidDatasetData="checkInvalidDatasetData",e.checkInvalidVector="checkInvalidVector",e.clearExpiredSubPlan="clearExpiredSubPlan",e.updateStandardPlan="updateStandardPlan",e.scheduleTriggerApp="scheduleTriggerApp"}(n||(n={}));let r={[n.checkInValidDatasetFiles]:"checkInValidDatasetFiles",[n.checkInvalidDatasetData]:"checkInvalidDatasetData",[n.checkInvalidVector]:"checkInvalidVector",[n.clearExpiredSubPlan]:"clearExpiredSubPlan",[n.updateStandardPlan]:"updateStandardPlan",[n.scheduleTriggerApp]:"scheduleTriggerApp"}},94541:(e,t,a)=>{"use strict";a.d(t,{s:()=>p});var n=a(48079),r=a(9819);let{Schema:o,model:s,models:i}=n.connectionMongo,l="systemtimerlocks",c=new o({timerId:{type:String,required:!0,unique:!0,enum:Object.keys(r.p)},expiredTime:{type:Date,required:!0}});try{c.index({expiredTime:1},{expireAfterSeconds:5})}catch(e){console.log(e)}let d=i[l]||s(l,c);d.syncIndexes();var u=a(45569),m=a.n(u);let p=async({timerId:e,lockMinuted:t})=>{try{return await d.create({timerId:e,expiredTime:m()(new Date,t)}),!0}catch(e){return!1}}},6218:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{MX:()=>d,Oj:()=>l,TJ:()=>p,VJ:()=>c,tB:()=>m,wF:()=>u});var r=a(61949),o=a(18112),s=e([o]);o=(s.then?(await s)():s)[0];let i=()=>new r.C,l=i().init,c=i().delete,d=i().recall,u=i().getVectorDataByTime,m=i().getVectorCountByTeamId,p=async({model:e,query:t,...a})=>{let{vectors:n,tokens:r}=await (0,o.r)({model:e,input:t,type:"db"}),{insertId:s}=await i().insert({...a,vectors:n});return{tokens:r,insertId:s}};n()}catch(e){n(e)}})},61949:(e,t,a)=>{"use strict";a.d(t,{C:()=>y});let n="modeldata";var r=a(10071),o=a(54032),s=a(1635),i=a.n(s);async function l(){try{await (0,o.L)(),await o.S.query(`
      CREATE EXTENSION IF NOT EXISTS vector;
      CREATE TABLE IF NOT EXISTS ${n} (
          id BIGSERIAL PRIMARY KEY,
          vector VECTOR(1536) NOT NULL,
          team_id VARCHAR(50) NOT NULL,
          dataset_id VARCHAR(50) NOT NULL,
          collection_id VARCHAR(50) NOT NULL,
          createtime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `),await o.S.query(`CREATE INDEX CONCURRENTLY IF NOT EXISTS vector_index ON ${n} USING hnsw (vector vector_ip_ops) WITH (m = 32, ef_construction = 100);`),await o.S.query(`CREATE INDEX CONCURRENTLY IF NOT EXISTS team_dataset_collection_index ON ${n} USING btree(team_id, dataset_id, collection_id);`),await o.S.query(`CREATE INDEX CONCURRENTLY IF NOT EXISTS create_time_index ON ${n} USING btree(createtime);`),console.log("init pg successful")}catch(e){console.log("init pg error",e)}}let c=async e=>{let{teamId:t,datasetId:a,collectionId:s,vectors:i,retry:l=3}=e;try{let{rows:e}=await o.S.insert(n,{values:[[{key:"vector",value:`[${i[0]}]`},{key:"team_id",value:String(t)},{key:"dataset_id",value:String(a)},{key:"collection_id",value:String(s)}]]});return{insertId:e[0].id}}catch(t){if(l<=0)return Promise.reject(t);return await (0,r.g)(500),c({...e,retry:l-1})}},d=async e=>{let{teamId:t,retry:a=2}=e,s=`team_id='${String(t)}' AND`,i=await (()=>{if("id"in e&&e.id)return`${s} id=${e.id}`;if("datasetIds"in e&&e.datasetIds){let t=`dataset_id IN (${e.datasetIds.map(e=>`'${String(e)}'`).join(",")})`;return"collectionIds"in e&&e.collectionIds?`${s} ${t} AND collection_id IN (${e.collectionIds.map(e=>`'${String(e)}'`).join(",")})`:`${s} ${t}`}return"idList"in e&&e.idList?`${s} id IN (${e.idList.map(e=>`'${String(e)}'`).join(",")})`:Promise.reject("deleteDatasetData: no where")})();try{await o.S.delete(n,{where:[i]})}catch(t){if(a<=0)return Promise.reject(t);return await (0,r.g)(500),d({...e,retry:a-1})}},u=async e=>{let{datasetIds:t,vectors:a,limit:r,similarity:s=0,retry:i=2,efSearch:l=100}=e;try{let e=await o.S.query(`BEGIN;
        SET LOCAL hnsw.ef_search = ${l};
        select id, collection_id, vector <#> '[${a[0]}]' AS score 
          from ${n} 
          where dataset_id IN (${t.map(e=>`'${String(e)}'`).join(",")})
              AND vector <#> '[${a[0]}]' < -${s}
          order by score limit ${r};
        COMMIT;`),i=e?.[2]?.rows;return{results:i.map(e=>({id:e.id,collectionId:e.collection_id,score:-1*e.score}))}}catch(t){if(i<=0)return Promise.reject(t);return u(e)}},m=async e=>{let t=await o.S.count(n,{where:[["team_id",String(e)]]});return t},p=async(e,t)=>{let{rows:a}=await o.S.query(`SELECT id, team_id, dataset_id
  FROM ${n}
  WHERE createtime BETWEEN '${i()(e).format("YYYY-MM-DD HH:mm:ss")}' AND '${i()(t).format("YYYY-MM-DD HH:mm:ss")}';
  `);return a.map(e=>({id:String(e.id),teamId:e.team_id,datasetId:e.dataset_id}))};class y{constructor(){this.init=l,this.insert=c,this.delete=d,this.recall=u,this.getVectorCountByTeamId=m,this.getVectorDataByTime=p}}},54032:(e,t,a)=>{"use strict";a.d(t,{S:()=>i,L:()=>s});var n=a(10071),r=a(7161),o=a(42861);let s=async()=>{if(global.pgClient)return global.pgClient;global.pgClient=new o.Pool({connectionString:process.env.PG_URL,max:Number(process.env.DB_MAX_LINK||20),min:10,keepAlive:!0,idleTimeoutMillis:6e5,connectionTimeoutMillis:2e4,query_timeout:3e4,statement_timeout:4e4,idle_in_transaction_session_timeout:6e4}),global.pgClient.on("error",async e=>{console.log(e),global.pgClient?.end(),global.pgClient=null,await (0,n.g)(1e3),r.B.info("Retry connect pg"),s()});try{return await global.pgClient.connect(),console.log("pg connected"),global.pgClient}catch(e){return global.pgClient?.end(),global.pgClient=null,await (0,n.g)(1e3),r.B.info("Retry connect pg"),s()}},i=new class{getWhereStr(e){return e?`WHERE ${e.map(e=>{if("string"==typeof e)return e;let t="number"==typeof e[1]?e[1]:`'${String(e[1])}'`;return`${e[0]}=${t}`}).join(" ")}`:""}getUpdateValStr(e){return e.map(e=>{let t="number"==typeof e.value?e.value:`'${String(e.value).replace(/\'/g,'"')}'`;return`${e.key}=${t}`}).join(",")}getInsertValStr(e){return e.map(e=>`(${e.map(e=>"number"==typeof e.value?e.value:`'${String(e.value).replace(/\'/g,'"')}'`).join(",")})`).join(",")}async select(e,t){let a=`SELECT ${t.fields&&t.fields?.length!==0?t.fields?.join(","):"*"}
      FROM ${e}
      ${this.getWhereStr(t.where)}
      ${t.order?`ORDER BY ${t.order.map(e=>`${e.field} ${e.mode}`).join(",")}`:""}
      LIMIT ${t.limit||10} OFFSET ${t.offset||0}
    `,n=await s();return n.query(a)}async count(e,t){let a=`SELECT COUNT(${t?.fields?.[0]||"*"})
      FROM ${e}
      ${this.getWhereStr(t.where)}
    `,n=await s();return n.query(a).then(e=>Number(e.rows[0]?.count||0))}async delete(e,t){let a=`DELETE FROM ${e} ${this.getWhereStr(t.where)}`,n=await s();return n.query(a)}async update(e,t){if(0===t.values.length)return{rowCount:0};let a=`UPDATE ${e} SET ${this.getUpdateValStr(t.values)} ${this.getWhereStr(t.where)}`,n=await s();return n.query(a)}async insert(e,t){if(0===t.values.length)return{rowCount:0,rows:[]};let a=t.values[0].map(e=>e.key).join(","),n=`INSERT INTO ${e} (${a}) VALUES ${this.getInsertValStr(t.values)} RETURNING id`,r=await s();return r.query(n)}async query(e){let t=await s(),a=Date.now();return t.query(e).then(t=>{let n=Date.now()-a;return n>300&&r.B.warn(`pg query time: ${n}ms, sql: ${e}`),t})}};global.pgClient},81190:(e,t,a)=>{"use strict";a.d(t,{c:()=>s,x:()=>o});var n=a(10114);let r=n.ZP,o=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",s=e=>{let{userKey:t,timeout:a}=e||{},n=t?.baseUrl||global?.systemEnv?.oneapiUrl||process.env.ONEAPI_URL||o,s=t?.key||global?.systemEnv?.chatApiKey||process.env.CHAT_API_KEY||"";return new r({baseURL:n,apiKey:s,httpAgent:global.httpsAgent,timeout:a,maxRetries:2})}},18112:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{r:()=>l});var r=a(81190),o=a(7110),s=a(93556),i=e([o]);async function l({model:e,input:t,type:a}){if(!t)return Promise.reject({code:500,message:"input is empty"});try{let n=(0,r.c)(),i=await n.embeddings.create({...e.defaultConfig,...a===s.hZ.db&&e.dbConfig,...a===s.hZ.query&&e.queryConfig,model:e.model,input:[t]}).then(async e=>{if(!e.data)return Promise.reject("Embedding API 404");if(!e?.data?.[0]?.embedding)return console.log(e),Promise.reject(e.data?.err?.message||"Embedding API Error");let[a,n]=await Promise.all([(0,o.BM)(t),Promise.all(e.data.map(e=>(function(e){if(e.length>1536)return console.log(`The current vector dimension is ${e.length}, and the vector dimension cannot exceed 1536. The first 1536 dimensions are automatically captured`),e.slice(0,1536);let t=e.length,a=Array(1536-t).fill(0);return e.concat(a)})(e.embedding)))]);return{tokens:a,vectors:n}});return i}catch(e){return console.log("Embedding Error",e),Promise.reject(e)}}o=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})},57803:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{H:()=>d});var r=a(935),o=a(81190),s=a(7110),i=a(49877),l=e([r,s]);[r,s]=l.then?(await l)():l;let c=`作为一个向量检索助手，你的任务是结合历史记录，从不同角度，为“原问题”生成个不同版本的“检索词”，从而提高向量检索的语义丰富度，提高向量检索的精度。生成的问题要求指向对象清晰明确，并与“原问题语言相同”。例如：
历史记录: 
"""
"""
原问题: 介绍下剧情。
检索词: ["介绍下故事的背景和主要人物。","故事的主题是什么？","剧情是是如何发展的？"]
----------------
历史记录: 
"""
Q: 对话背景。
A: 当前对话是关于 Nginx 的介绍和使用等。
"""
原问题: 怎么下载
检索词: ["Nginx 如何下载？","下载 Nginx 需要什么条件？","有哪些渠道可以下载 Nginx？"]
----------------
历史记录: 
"""
Q: 对话背景。
A: 当前对话是关于 Nginx 的介绍和使用等。
Q: 报错 "no connection"
A: 报错"no connection"可能是因为……
"""
原问题: 怎么解决
检索词: ["Nginx报错"no connection"如何解决？","造成'no connection'报错的原因。","Nginx提示'no connection'，要怎么办？"]
----------------
历史记录: 
"""
Q: 护产假多少天?
A: 护产假的天数根据员工所在的城市而定。请提供您所在的城市，以便我回答您的问题。
"""
原问题: 沈阳
检索词: ["沈阳的护产假多少天？"]
----------------
历史记录: 
"""
Q: 作者是谁？
A: FastGPT 的作者是 labring。
"""
原问题: Tell me about him
检索词: ["Introduce labring, the author of FastGPT." ," Background information on author labring." "," Why does labring do FastGPT?"]
----------------
历史记录:
"""
Q: 对话背景。
A: 关于 FatGPT 的介绍和使用等问题。
"""
原问题: 你好。
检索词: ["你好"]
----------------
历史记录:
"""
Q: FastGPT 如何收费？
A: FastGPT 收费可以参考……
"""
原问题: 你知道 laf 么？
检索词: ["laf是什么？","如何使用laf？","laf的介绍。"]
----------------
历史记录:
"""
Q: FastGPT 的优势
A: 1. 开源
   2. 简便
   3. 扩展性强
"""
原问题: 介绍下第2点。
检索词: ["介绍下 FastGPT 简便的优势", "FastGPT 为什么使用起来简便？","FastGPT的有哪些简便的功能？"]。
----------------
历史记录:
"""
Q: 什么是 FastGPT？
A: FastGPT 是一个 RAG 平台。
Q: 什么是 Laf？
A: Laf 是一个云函数开发平台。
"""
原问题: 它们有什么关系？
检索词: ["FastGPT和Laf有什么关系？","FastGPT的RAG是用Laf实现的么？"]
----------------
历史记录:
"""
{{histories}}
"""
原问题: {{query}}
检索词: `,d=async({chatBg:e,query:t,histories:a=[],model:n})=>{let l=e?`Q: 对话背景。
A: ${e}
`:"",d=a.map(e=>{let t="Human"===e.obj?"Q":"A";return`${t}: ${(0,i.z2)(e.value).text}`}).join("\n"),u=`${l}${d}`.trim(),m=(0,o.c)({timeout:48e4}),p=[{role:"user",content:(0,r.Fm)(c,{query:`${t}`,histories:u})}],y=await m.chat.completions.create({model:n,temperature:.01,messages:p,stream:!1}),f=y.choices?.[0]?.message?.content||"";if(!f)return{rawQuery:t,extensionQueries:[],model:n,tokens:0};f=f.replace(/\\"/g,'"');try{let e=JSON.parse(f);return{rawQuery:t,extensionQueries:Array.isArray(e)?e:[],model:n,tokens:await (0,s.et)(p)}}catch(e){return console.log(e),{rawQuery:t,extensionQueries:[],model:n,tokens:0}}};n()}catch(e){n(e)}})},83249:(e,t,a)=>{"use strict";var n;a.d(t,{BA:()=>s,DA:()=>r,I5:()=>o,Lj:()=>i,Mj:()=>n,yT:()=>l});let r=e=>global.llmModels.find(t=>t.model===e)??global.llmModels[0],o=e=>global.llmModels?.filter(e=>e.datasetProcess)?.find(t=>t.model===e)??global.llmModels[0],s=e=>global.vectorModels.find(t=>t.model===e)||global.vectorModels[0];function i(e){return global.audioSpeechModels.find(t=>t.model===e)||global.audioSpeechModels[0]}!function(e){e.llm="llm",e.vector="vector",e.audioSpeech="audioSpeech",e.whisper="whisper",e.rerank="rerank"}(n||(n={}));let l={[n.llm]:r,[n.vector]:s,[n.audioSpeech]:i,[n.whisper]:function(e){return global.whisperModel},[n.rerank]:function(e){return global.reRankModels.find(t=>t.model===e)}}},57606:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{n:()=>s});var r=a(33746),o=e([r]);function s({query:e,documents:t}){let a=global.reRankModels[0];if(!a||!a?.requestUrl)return Promise.reject("no rerank model");let n=Date.now();return(0,r.a4)(a.requestUrl,{model:a.model,query:e,documents:t.map(e=>e.text)},{headers:{Authorization:`Bearer ${a.requestAuth}`},timeout:3e4}).then(e=>(console.log("rerank time:",Date.now()-n),e?.results?.map(e=>({id:t[e.index].id,score:e.relevance_score})))).catch(e=>(console.log("rerank error:",e),[]))}r=(o.then?(await o)():o)[0],n()}catch(e){n(e)}})},8487:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Zb:()=>m,_q:()=>u,uV:()=>d}),a(88068);var r=a(7110),o=a(99648),s=a(93556),i=a(17639),l=e([r,o]);[r,o]=l.then?(await l)():l;let c=e=>e.filter(e=>e.role===s.NZ.System||e.role===s.NZ.User?!!e.content:e.role!==s.NZ.Assistant||!!e.content||!!e.function_call||!!e.tool_calls),d=async({messages:e=[],maxTokens:t})=>{if(!Array.isArray(e))return[];let a=e.reduce((e,t)=>"string"==typeof t.content?e+t.content.length:Array.isArray(t.content)?e+t.content.reduce((e,t)=>"text"===t.type?e+t.text.length:e,0):e,0);if(a<.5*t)return c(e);let n=e.findIndex(e=>e.role!==s.NZ.System),o=e.slice(0,n),i=e.slice(n);t-=await (0,r.et)(o);let l=i.pop();if(!l)return o;let d=[l];for(;;){let e=i.pop(),a=i.pop();if(!e||!a)break;let n=await (0,r.et)([e,a]);if((t-=n)<0||(d.unshift(e),d.unshift(a),0===i.length))break}return c([...o,...d])},u=e=>e.map(e=>{if(e.content){if("string"==typeof e.content)return{...e,content:e.content.trim()};if(0!==e.content.length)return 1===e.content.length&&"text"===e.content[0].type?{...e,content:e.content[0].text}:e}}).filter(Boolean),m=async e=>"string"==typeof e?e:Promise.all(e.map(async e=>{if("text"===e.type)return e;let t=await o.default.get(e.image_url.url,{responseType:"arraybuffer"}),a=Buffer.from(t.data).toString("base64"),n=t.headers["content-type"];return void 0===n&&(n=(0,i.Ok)(a)),e.image_url.url=`data:${n};base64,${a}`,e}));n()}catch(e){n(e)}})},3815:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{AL:()=>p,Ne:()=>g,h$:()=>f,qR:()=>y});var r=a(89645),o=a(72912),s=a(92677),i=a(83801),l=a(89642),c=a(6218),d=a(57749),u=a(22011),m=e([c,d]);async function p({teamId:e,tmbId:t,name:a,parentId:n,datasetId:s,type:i,trainingType:l=r.g0.chunk,chunkSize:c=512,chunkSplitter:d,qaPrompt:u,fileId:m,rawLink:p,hashRawText:f,rawTextLength:g,metadata:h={},session:w,...b}){let[v]=await o.w.create([{...b,teamId:e,tmbId:t,parentId:n||null,datasetId:s,name:a,type:i,trainingType:l,chunkSize:c,chunkSplitter:d,qaPrompt:u,fileId:m,rawLink:p,rawTextLength:g,hashRawText:f,metadata:h}],{session:w});return i===r.Ug.folder&&await y({datasetId:s,parentId:v._id,teamId:e,tmbId:t,session:w}),v}function y({name:e="手动录入",datasetId:t,parentId:a,teamId:n,tmbId:s,session:i}){return o.w.create([{name:e,teamId:n,tmbId:s,datasetId:t,parentId:a,type:r.Ug.virtual,trainingType:r.g0.chunk,chunkSize:0,updateTime:new Date("2099")}],{session:i})}[c,d]=m.then?(await m)():m;let g=async({collections:e,session:t})=>{if(0===e.length)return;let a=e[0].teamId;if(!a)return Promise.reject("teamId is not exist");let n=e.map(e=>e?.fileId||"").filter(Boolean),r=e.map(e=>e?.metadata?.relatedImgId||"").filter(Boolean);await (0,l.Rf)({teamId:a,relateIds:r,session:t}),await (0,d.hh)({bucketName:u.ns.dataset,fileIdList:n})};async function f({collections:e,session:t}){if(0===e.length)return;let a=e[0].teamId;if(!a)return Promise.reject("teamId is not exist");let n=Array.from(new Set(e.map(e=>"string"==typeof e.datasetId?String(e.datasetId):String(e.datasetId._id)))),r=e.map(e=>String(e._id));await g({collections:e,session:t}),await s.X.deleteMany({teamId:a,datasetIds:{$in:n},collectionId:{$in:r}}),await i.o.deleteMany({teamId:a,datasetIds:{$in:n},collectionId:{$in:r}},{session:t}),await o.w.deleteMany({_id:{$in:r}},{session:t}),await (0,c.VJ)({teamId:a,datasetIds:n,collectionIds:r})}n()}catch(e){n(e)}})},72912:(e,t,a)=>{"use strict";a.d(t,{s:()=>d,w:()=>m});var n=a(48079),r=a(89645),o=a(53457),s=a(3036);let{Schema:i,model:l,models:c}=n.connectionMongo,d="dataset.collections",u=new i({parentId:{type:i.Types.ObjectId,ref:d,default:null},userId:{type:i.Types.ObjectId,ref:"user"},teamId:{type:i.Types.ObjectId,ref:s.NG,required:!0},tmbId:{type:i.Types.ObjectId,ref:s.T5,required:!0},datasetId:{type:i.Types.ObjectId,ref:o.H,required:!0},type:{type:String,enum:Object.keys(r.V0),required:!0},name:{type:String,required:!0},createTime:{type:Date,default:()=>new Date},updateTime:{type:Date,default:()=>new Date},trainingType:{type:String,enum:Object.keys(r.Qw),required:!0},chunkSize:{type:Number,required:!0},chunkSplitter:{type:String},qaPrompt:{type:String},fileId:{type:i.Types.ObjectId,ref:"dataset.files"},rawLink:{type:String},rawTextLength:{type:Number},hashRawText:{type:String},metadata:{type:Object,default:{}}});try{u.index({teamId:1,fileId:1},{background:!0}),u.index({teamId:1,datasetId:1,parentId:1,updateTime:-1},{background:!0})}catch(e){console.log(e)}let m=c[d]||l(d,u)},39707:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Ss:()=>u,Vb:()=>p,u9:()=>m});var r=a(72912),o=a(53457),s=a(3815),i=a(92677),l=a(83801),c=a(6218),d=e([s,c]);async function u({teamId:e,datasetId:t,fields:a}){let n=async t=>{let r=await o.r.find({teamId:e,parentId:t},a).lean(),s=r;for(let e of r){let t=await n(e._id);s=s.concat(t)}return s},[r,s]=await Promise.all([o.r.findById(t),n(t)]);return r?[r,...s]:Promise.reject("Dataset not found")}async function m(e){let t=await r.w.findById(e).populate("datasetId").lean();return t||Promise.reject("Collection is not exist")}async function p({datasets:e,session:t}){if(!e.length)return;let a=e[0].teamId;if(!a)return Promise.reject("teamId is required");let n=e.map(e=>String(e._id)),o=await r.w.find({teamId:a,datasetId:{$in:n}},"_id teamId fileId metadata").lean();await (0,s.Ne)({collections:o,session:t}),await i.X.deleteMany({teamId:a,datasetId:{$in:n}}),await l.o.deleteMany({teamId:a,datasetId:{$in:n}},{session:t}),await r.w.deleteMany({teamId:a,datasetId:{$in:n}},{session:t}),await (0,c.VJ)({teamId:a,datasetIds:n})}[s,c]=d.then?(await d)():d,n()}catch(e){n(e)}})},83801:(e,t,a)=>{"use strict";a.d(t,{Q:()=>d,o:()=>m});var n=a(48079),r=a(3036),o=a(53457),s=a(72912);let{Schema:i,model:l,models:c}=n.connectionMongo,d="dataset.datas",u=new i({teamId:{type:i.Types.ObjectId,ref:r.NG,required:!0},tmbId:{type:i.Types.ObjectId,ref:r.T5,required:!0},datasetId:{type:i.Types.ObjectId,ref:o.H,required:!0},collectionId:{type:i.Types.ObjectId,ref:s.s,required:!0},q:{type:String,required:!0},a:{type:String,default:""},fullTextToken:{type:String,default:""},indexes:{type:[{defaultIndex:{type:Boolean,default:!1},dataId:{type:String,required:!0},text:{type:String,required:!0}}],default:[]},updateTime:{type:Date,default:()=>new Date},chunkIndex:{type:Number,default:0},inited:{type:Boolean}});try{u.index({teamId:1,datasetId:1,collectionId:1,chunkIndex:1,updateTime:-1},{background:!0}),u.index({teamId:1,datasetId:1,fullTextToken:"text"},{background:!0}),u.index({teamId:1,datasetId:1,collectionId:1,"indexes.dataId":1},{background:!0}),u.index({updateTime:1},{background:!0})}catch(e){console.log(e)}let m=c[d]||l(d,u);m.syncIndexes()},53457:(e,t,a)=>{"use strict";a.d(t,{H:()=>d,r:()=>m});var n=a(48079),r=a(89645),o=a(3036),s=a(86721);let{Schema:i,model:l,models:c}=n.connectionMongo,d="datasets",u=new i({parentId:{type:i.Types.ObjectId,ref:d,default:null},userId:{type:i.Types.ObjectId,ref:"user"},teamId:{type:i.Types.ObjectId,ref:o.NG,required:!0},tmbId:{type:i.Types.ObjectId,ref:o.T5,required:!0},type:{type:String,enum:Object.keys(r.o5),required:!0,default:r.ie.dataset},status:{type:String,enum:Object.keys(r.Ls),default:r.$8.active},avatar:{type:String,default:"/icon/logo.svg"},name:{type:String,required:!0},updateTime:{type:Date,default:()=>new Date},vectorModel:{type:String,required:!0,default:"text-embedding-ada-002"},agentModel:{type:String,required:!0,default:"gpt-3.5-turbo"},intro:{type:String,default:""},permission:{type:String,enum:Object.keys(s.Ut),default:s.Pm.private},websiteConfig:{type:{url:{type:String,required:!0},selector:{type:String,default:"body"}}}});try{u.index({teamId:1})}catch(e){console.log(e)}let m=c[d]||l(d,u);m.syncIndexes()},25412:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{n:()=>g});var r=a(89645),o=a(6218),s=a(18112),i=a(83249),l=a(83801),c=a(72912),d=a(57606),u=a(7110),m=a(18605),p=a(935),y=a(61292),f=e([o,s,d,u,p]);async function g(e){let{teamId:t,reRankQuery:a,queries:n,model:f,similarity:g=0,limit:h,searchMode:w=r.wq.embedding,usingReRank:b=!1,datasetIds:v=[]}=e;w=r.Nz[w]?w:r.wq.embedding,b=b&&global.reRankModels.length>0,h<50&&(h=1500);let I=new Set,x=!1,T=async({query:e,limit:a})=>{let{vectors:n,tokens:c}=await (0,s.r)({model:(0,i.BA)(f),input:e,type:"query"}),{results:d}=await (0,o.MX)({vectors:n,limit:a,datasetIds:v,efSearch:global.systemEnv?.pgHNSWEfSearch}),u=await l.o.find({teamId:t,datasetId:{$in:v},collectionId:{$in:d.map(e=>e.collectionId)},"indexes.dataId":{$in:d.map(e=>e.id?.trim())}},"datasetId collectionId q a chunkIndex indexes").populate("collectionId","name fileId rawLink").lean(),m=u.map(e=>{let t=e.indexes.map(e=>e.dataId),a=d.find(e=>t.includes(e.id));return{...e,score:a?.score||0}});m.sort((e,t)=>t.score-e.score);let p=m.map((e,t)=>{e.collectionId||console.log("Collection is not found",e);let a={id:String(e._id),q:e.q,a:e.a,chunkIndex:e.chunkIndex,datasetId:String(e.datasetId),collectionId:String(e.collectionId?._id),sourceName:e.collectionId?.name||"",sourceId:e.collectionId?.fileId||e.collectionId?.rawLink,score:[{type:r.ds.embedding,value:e.score,index:t}]};return a}).filter(e=>null!==e);return{embeddingRecallResults:p,tokens:c}},S=async({query:e,limit:a})=>{if(0===a)return{fullTextRecallResults:[],tokenLen:0};let n=(await Promise.all(v.map(n=>l.o.find({teamId:t,datasetId:n,$text:{$search:(0,y.P)({text:e})}},{score:{$meta:"textScore"},_id:1,datasetId:1,collectionId:1,q:1,a:1,chunkIndex:1}).sort({score:{$meta:"textScore"}}).limit(a).lean()))).flat();n.sort((e,t)=>t.score-e.score),n.slice(0,a);let o=await c.w.find({_id:{$in:n.map(e=>e.collectionId)}},"_id name fileId rawLink");return{fullTextRecallResults:n.map((e,t)=>{let a=o.find(t=>String(t._id)===String(e.collectionId));return{id:String(e._id),datasetId:String(e.datasetId),collectionId:String(e.collectionId),sourceName:a?.name||"",sourceId:a?.fileId||a?.rawLink,q:e.q,a:e.a,chunkIndex:e.chunkIndex,indexes:e.indexes,score:[{type:r.ds.fullText,value:e.score,index:t}]}}),tokenLen:0}},k=async({data:e,query:t})=>{try{let a=await (0,d.n)({query:t,documents:e.map(e=>({id:e.id,text:`${e.q}
${e.a}`}))});if(0===a.length)return b=!1,[];let n=a.map((t,a)=>{let n=e.find(e=>e.id===t.id);if(!n)return null;let o=t.score||0;return{...n,score:[{type:r.ds.reRank,value:o,index:a}]}}).filter(Boolean);return n}catch(e){return b=!1,[]}},N=async(e,t)=>{let a=[],n=0;for await(let r of e)if((n+=await (0,u.BM)(r.q+r.a))>t+500||(a.push(r),n>t))break;return 0===a.length?e.slice(0,1):a},A=async({embeddingLimit:e,fullTextLimit:t})=>{let a=[],r=[],o=0;await Promise.all(n.map(async n=>{let[{tokens:s,embeddingRecallResults:i},{fullTextRecallResults:l}]=await Promise.all([T({query:n,limit:e}),S({query:n,limit:t})]);o+=s,a.push(i),r.push(l)}));let s=(0,m.o)(a.map(e=>({k:60,list:e}))).slice(0,e),i=(0,m.o)(r.map(e=>({k:60,list:e}))).slice(0,t);return{tokens:o,embeddingRecallResults:s,fullTextRecallResults:i}},{embeddingLimit:P,fullTextLimit:q}=w===r.wq.embedding?{embeddingLimit:150,fullTextLimit:0}:w===r.wq.fullTextRecall?{embeddingLimit:0,fullTextLimit:150}:{embeddingLimit:100,fullTextLimit:80},{embeddingRecallResults:R,fullTextRecallResults:j,tokens:$}=await A({embeddingLimit:P,fullTextLimit:q}),E=await (async()=>{if(!b)return[];I=new Set(R.map(e=>e.id));let e=R.concat(j.filter(e=>!I.has(e.id)));I=new Set;let t=e.filter(e=>{let t=(0,p.ck)(`${e.q}${e.a}`.replace(/[^\p{L}\p{N}]/gu,""));return!I.has(t)&&(I.add(t),!0)});return k({query:a,data:t})})(),O=(0,m.o)([{k:60,list:R},{k:60,list:j},{k:58,list:E}]);I=new Set;let D=O.filter(e=>{let t=(0,p.ck)(`${e.q}${e.a}`.replace(/[^\p{L}\p{N}]/gu,""));return!I.has(t)&&(I.add(t),!0)}),M=b?(x=!0,D.filter(e=>{let t=e.score.find(e=>e.type===r.ds.reRank);return!t||!(t.value<g)})):w===r.wq.embedding?(x=!0,D.filter(e=>{let t=e.score.find(e=>e.type===r.ds.embedding);return!t||!(t.value<g)})):D;return{searchRes:await N(M,h),tokens:$,searchMode:w,limit:h,similarity:g,usingReRank:b,usingSimilarityFilter:x}}[o,s,d,u,p]=f.then?(await f)():f,n()}catch(e){n(e)}})},72346:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{g:()=>i});var r=a(57803),o=a(935),s=e([r,o]);[r,o]=s.then?(await s)():s;let i=async({query:e,extensionModel:t,extensionBg:a="",histories:n=[]})=>{let s=e=>{let t=new Set,a=e.filter(e=>{let a=(0,o.ck)(e.replace(/[^\p{L}\p{N}]/gu,""));return!t.has(a)&&(t.add(a),!0)});return a},{queries:i,rewriteQuery:l,alreadyExtension:c}=(()=>{let t=n.length>0?`${n.map(e=>`${e.obj}: ${e.value}`).join("\n")}
  Human: ${e}
  `:e;try{let a=JSON.parse(e),n=Array.isArray(a)?s(a):[e],r=Array.isArray(a);return{queries:n,rewriteQuery:r?n.join("\n"):t,alreadyExtension:r}}catch(a){return{queries:[e],rewriteQuery:t,alreadyExtension:!1}}})(),d=await (async()=>{if(!t||c)return;let o=await (0,r.H)({chatBg:a,query:e,histories:n,model:t.model});if(o.extensionQueries?.length!==0)return o})();return d&&(l=(i=s(i.concat(d.extensionQueries))).join("\n")),{concatQueries:i,rewriteQuery:l,aiExtensionResult:d}};n()}catch(e){n(e)}})},59659:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{I2:()=>m,W9:()=>p,s6:()=>u});var r=a(92677),o=a(89645),s=a(935),i=a(83249),l=a(7161),c=a(39707),d=e([s,c]);[s,c]=d.then?(await d)():d;let m=async e=>{try{await r.X.updateMany({teamId:e},{lockTime:new Date("2999/5/5")})}catch(e){}},p=async({collectionId:e,...t})=>{let{datasetId:{_id:a,agentModel:n,vectorModel:r}}=await (0,c.u9)(e);return u({...t,datasetId:a,collectionId:e,agentModel:n,vectorModel:r})};async function u({teamId:e,tmbId:t,datasetId:a,collectionId:n,agentModel:c,vectorModel:d,data:u,prompt:m,billId:p,trainingMode:y=o.g0.chunk,session:f}){let g=async()=>{let e=(0,i.DA)(c);if(!e)return Promise.reject(`File model ${c} is inValid`);let t=(0,i.BA)(d);return t?y===o.g0.chunk?{maxToken:1.3*t.maxToken,model:t.model,weight:t.weight}:y===o.g0.qa||y===o.g0.auto?{maxToken:.8*e.maxContext,model:e.model,weight:0}:Promise.reject(`Training mode "${y}" is inValid`):Promise.reject(`Vector model ${d} is inValid`)},{model:h,maxToken:w,weight:b}=await g();u.forEach(e=>{e.q=(0,s.Av)(e.q),e.a=(0,s.Av)(e.a),e.indexes=e.indexes?.map(e=>({...e,text:s.Av(e.text)})).filter(Boolean)});let v=new Set,I={success:[],overToken:[],repeat:[],error:[]};u.forEach(e=>{if(!e.q){I.error.push(e);return}let t=e.q+e.a,a=e.q.length;if(a>w){I.overToken.push(e);return}v.has(t)?(console.log("repeat",e),I.repeat.push(e)):(I.success.push(e),v.add(t))});let x=I.success.length,T=[];try{await r.X.insertMany(I.success.map(r=>({teamId:e,tmbId:t,datasetId:a,collectionId:n,billId:p,mode:y,prompt:m,model:h,q:r.q,a:r.a,chunkIndex:r.chunkIndex??0,weight:b??0,indexes:r.indexes})),{session:f})}catch(e){l.B.error("Insert error",e),e.writeErrors.forEach(e=>{T.push(u[e.index])}),console.log("failed",T)}for await(let e of T)await r.X.create(e);return delete I.success,{insertLen:x,...I}}n()}catch(e){n(e)}})},92677:(e,t,a)=>{"use strict";a.d(t,{X:()=>p,m:()=>u});var n=a(48079),r=a(89645),o=a(72912),s=a(53457),i=a(3036);let{Schema:l,model:c,models:d}=n.connectionMongo,u="dataset.trainings",m=new l({teamId:{type:l.Types.ObjectId,ref:i.NG,required:!0},tmbId:{type:l.Types.ObjectId,ref:i.T5,required:!0},datasetId:{type:l.Types.ObjectId,ref:s.H,required:!0},collectionId:{type:l.Types.ObjectId,ref:o.s,required:!0},billId:{type:String,default:""},mode:{type:String,enum:Object.keys(r.Qw),required:!0},expireAt:{type:Date,default:()=>new Date},lockTime:{type:Date,default:()=>new Date("2000/1/1")},model:{type:String,required:!0},prompt:{type:String,default:""},q:{type:String,required:!0},a:{type:String,default:""},chunkIndex:{type:Number,default:0},weight:{type:Number,default:0},indexes:{type:[{text:{type:String,required:!0}}],default:[]}});try{m.index({teamId:1,datasetId:1}),m.index({mode:1,lockTime:1,weight:-1}),m.index({expireAt:1},{expireAfterSeconds:604800})}catch(e){console.log(e)}let p=d[u]||c(u,m);p.syncIndexes()},86700:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Q:()=>d,s:()=>u});var r=a(7161),o=a(66743),s=a(92677),i=a(36658),l=a.n(i),c=e([o]);o=(c.then?(await c)():c)[0];let d=async({err:e,errText:t,data:a})=>{if(e?.response?r.B.error(`openai error: ${t}`,{status:e.response?.status,statusText:e.response?.statusText,data:e.response?.data}):r.B.error((0,o.v)(e,t),e),e?.message==="invalid message format"||e?.type==="invalid_request_error"||e?.code===500){r.B.info("Lock training data"),console.log(e);try{await s.X.findByIdAndUpdate(a._id,{lockTime:new Date("2998/5/5")})}catch(e){}return!0}return!1},u=e=>{let t=l().parse(e).data,a=t.map(e=>({q:e[0]||"",a:e[1]||""})).filter(e=>e.q||e.a);return{chunks:a}};n()}catch(e){n(e)}})},24365:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{hA:()=>p,hX:()=>m,n7:()=>y});var r=a(36962),o=a(81413),s=a(27378),i=a(85686),l=a(88844),c=a(46498),d=a(935),u=e([d]);async function m(e){let t=e.split("-");if(1===t.length)return{source:i.C9.personal,pluginId:e};let[a,n]=e.split("-");return a&&n?{source:a,pluginId:e}:Promise.reject("pluginId not found")}d=(u.then?(await u)():u)[0];let f=async e=>{let{source:t,pluginId:a}=await m(e);if(t===i.C9.community){let e=global.communityPlugins?.find(e=>e.id===a);return e||Promise.reject("plugin not found")}if(t===i.C9.personal){let t=await r.S.findById(e).lean();return t?{id:String(t._id),teamId:String(t.teamId),name:t.name,avatar:t.avatar,intro:t.intro,showStatus:!0,source:i.C9.personal,nodes:t.modules,edges:t.edges,templateType:l.z9.personalPlugin,isTool:!0}:Promise.reject("plugin not found")}return Promise.reject("plugin not found")};async function p({id:e}){let t=await f(e);return{id:(0,d.Cj)(),pluginId:t.id,templateType:t.templateType,flowNodeType:o.Jm.pluginModule,avatar:t.avatar,name:t.name,intro:t.intro,showStatus:t.showStatus,isTool:t.isTool,sourceHandle:(0,c.b)(!0,!0,!0,!0),targetHandle:(0,c.b)(!0,!0,!0,!0),...(0,s.h_)(t.nodes)}}async function y(e){let t=await f(e);return{teamId:t.teamId,name:t.name,avatar:t.avatar,showStatus:t.showStatus,nodes:t.nodes,edges:t.edges}}n()}catch(e){n(e)}})},36962:(e,t,a)=>{"use strict";a.d(t,{S:()=>u});var n=a(85686),r=a(48079),o=a(3036);let{Schema:s,model:i,models:l}=r.connectionMongo,c="plugins",d=new s({parentId:{type:s.Types.ObjectId,ref:c,default:null},teamId:{type:s.Types.ObjectId,ref:o.NG,required:!0},tmbId:{type:s.Types.ObjectId,ref:o.T5,required:!0},type:{type:String,enum:Object.keys(n._H),required:!0},name:{type:String,required:!0},avatar:{type:String,default:"/icon/logo.svg"},intro:{type:String,default:""},updateTime:{type:Date,default:()=>new Date},modules:{type:Array,default:[]},edges:{type:Array,default:[]},metadata:{type:{pluginUid:String,apiSchemaStr:String,customHeaders:String}},version:{type:String,enum:["v1","v2"]}});try{d.index({teamId:1,parentId:1}),d.index({teamId:1,name:1,intro:1})}catch(e){console.log(e)}let u=l[c]||i(c,d);u.syncIndexes()},62475:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{l:()=>h});var r=a(49877),o=a(7110),s=a(88068),i=a(81190),l=a(88844),c=a(33422),d=a(935),u=a(44201),m=a(83249),p=a(44767),y=a(34279),f=a(27378),g=e([o,d]);[o,d]=g.then?(await g)():g;let h=async e=>{let{user:t,node:{nodeId:a,name:n},histories:r,params:{model:o,history:s=6,agents:i,userChatInput:d}}=e;if(!d)return Promise.reject("Input is empty");let u=(0,m.DA)(o),g=(0,p.wT)(s,r),{arg:h,tokens:b}=await w({...e,histories:g,cqModel:u}),v=i.find(e=>e.key===h?.type)||i[i.length-1],{totalPoints:I,modelName:x}=(0,y.m)({model:u.model,tokens:b,modelType:m.Mj.llm});return{[l.YQ.cqResult]:v.value,[c.wk.skipHandleId]:i.filter(e=>e.key!==h?.type).map(e=>(0,f.xH)(a,"source",e.key)),[c.wk.nodeResponse]:{totalPoints:t.openaiAccount?.key?0:I,model:x,query:d,tokens:b,cqList:i,cqResult:v.value,contextTotalLen:g.length+2},[c.wk.nodeDispatchUsages]:[{moduleName:n,totalPoints:t.openaiAccount?.key?0:I,model:x,tokens:b}]}},w=async({cqModel:e,user:t,histories:a,params:{agents:n,systemPrompt:l="",userChatInput:c}})=>{let m=[{obj:s.LG.Human,value:[{type:s.Dl.text,text:{content:(0,d.Fm)(e.customCQPrompt||u.qA,{systemPrompt:l||"null",typeList:n.map(e=>`{"类型ID":"${e.key}", "问题类型":"${e.value}"}`).join("------"),history:a.map(e=>`${e.obj}:${(0,r.z2)(e.value).text}`).join("------"),question:c})}}]}],p=(0,i.c)({userKey:t.openaiAccount,timeout:48e4}),y=await p.chat.completions.create({model:e.model,temperature:.01,messages:(0,r.vC)({messages:m,reserveId:!1}),stream:!1}),f=y.choices?.[0].message?.content||"";console.log(JSON.stringify((0,r.vC)({messages:m,reserveId:!1}),null,2)),console.log(f,"----");let g=n.find(e=>f.includes(e.key))?.key||n.find(e=>f.includes(e.value))?.key||"";return{tokens:await (0,o.SG)(m),arg:{type:g}}};n()}catch(e){n(e)}})},59558:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{m:()=>v});var r=a(49877),o=a(8487),s=a(7110),i=a(88068),l=a(81190),c=a(88844),d=a(33422),u=a(44201),m=a(935),p=a(44767),y=a(83249),f=a(34279),g=a(24385),h=a.n(g),w=a(93556),b=e([o,s,m]);[o,s,m]=b.then?(await b)():b;let I="request_function";async function v(e){let{user:t,node:{name:a},histories:n,params:{content:r,history:o=6,model:s,description:i,extractKeys:l}}=e;if(!r)return Promise.reject("Input is empty");let u=(0,y.DA)(s),m=(0,p.wT)(o,n),{arg:g,tokens:h}=await (async()=>u.toolChoice?T({...e,histories:m,extractModel:u}):u.functionCall?S({...e,histories:m,extractModel:u}):k({...e,histories:m,extractModel:u}))();for(let e in g){let t=l.find(t=>t.key===e);t||delete g[e],""===g[e]&&delete g[e]}l.forEach(e=>{e.required&&!g[e.key]&&(g[e.key]=e.defaultValue||"")});let w=!l.find(e=>!(e.key in g));if(w)for(let e in g){let t=l.find(t=>t.key===e);if(!t){w=!1;break}}let{totalPoints:b,modelName:v}=(0,f.m)({model:u.model,tokens:h,modelType:y.Mj.llm});return{[c.YQ.contextExtractFields]:JSON.stringify(g),...g,[d.wk.nodeResponse]:{totalPoints:t.openaiAccount?.key?0:b,model:v,query:r,tokens:h,extractDescription:i,extractResult:g,contextTotalLen:m.length+2},[d.wk.nodeDispatchUsages]:[{moduleName:a,totalPoints:t.openaiAccount?.key?0:b,model:v,tokens:h}]}}let x=async({extractModel:e,histories:t,params:{content:a,extractKeys:n,description:s}})=>{let l=[...t,{obj:i.LG.Human,value:[{type:i.Dl.text,text:{content:`我正在执行一个函数，需要你提供一些参数，请以 JSON 字符串格式返回这些参数，要求：
"""
${s?`- ${s}`:""}
- 不是每个参数都是必须生成的，如果没有合适的参数值，不要生成该参数，或返回空字符串。
- 需要结合前面的对话内容，一起生成合适的参数。
"""

本次输入内容: ${a}
            `}}]}],c=(0,r.vC)({messages:l,reserveId:!1}),d=await (0,o.uV)({messages:c,maxTokens:e.maxContext}),u={};return n.forEach(e=>{u[e.key]={type:"string",description:e.desc,...e.enum?{enum:e.enum.split("\n")}:{}}}),{filterMessages:d,agentFunction:{name:I,description:"需要执行的函数",parameters:{type:"object",properties:u,required:[]}}}},T=async e=>{let{user:t,extractModel:a}=e,{filterMessages:n,agentFunction:r}=await x(e),o=[{type:"function",function:r}],i=(0,l.c)({userKey:t.openaiAccount,timeout:48e4}),c=await i.chat.completions.create({model:a.model,temperature:0,messages:n,tools:o,tool_choice:{type:"function",function:{name:I}}}),d=(()=>{try{return h().parse(c?.choices?.[0]?.message?.tool_calls?.[0]?.function?.arguments||"{}")}catch(e){return console.log(r.parameters),console.log(c.choices?.[0]?.message?.tool_calls?.[0]?.function),console.log("Your model may not support tool_call",e),{}}})(),u=[...n,{role:w.NZ.Assistant,tool_calls:c.choices?.[0]?.message?.tool_calls}];return{tokens:await (0,s.et)(u,o),arg:d}},S=async e=>{let{user:t,extractModel:a}=e,{agentFunction:n,filterMessages:r}=await x(e),o=[n],i=(0,l.c)({userKey:t.openaiAccount,timeout:48e4}),c=await i.chat.completions.create({model:a.model,temperature:0,messages:r,function_call:{name:I},functions:o});try{let e=JSON.parse(c?.choices?.[0]?.message?.function_call?.arguments||""),t=[...r,{role:w.NZ.Assistant,function_call:c.choices?.[0]?.message?.function_call}];return{arg:e,tokens:await (0,s.et)(t,void 0,o)}}catch(e){return console.log(c.choices?.[0]?.message),console.log("Your model may not support toll_call",e),{arg:{},tokens:0}}},k=async({extractModel:e,user:t,histories:a,params:{content:n,extractKeys:o,description:c}})=>{let d=[{obj:i.LG.Human,value:[{type:i.Dl.text,text:{content:(0,m.Fm)(e.customExtractPrompt||u.wL,{description:c,json:o.map(e=>`{"key":"${e.key}", "description":"${e.desc}"${e.enum?`, "enum":"[${e.enum.split("\n")}]"`:""}}`).join("\n"),text:`${a.map(e=>`${e.obj}:${(0,r.z2)(e.value).text}`).join("\n")}
Human: ${n}`})}}]}],p=(0,l.c)({userKey:t.openaiAccount,timeout:48e4}),y=await p.chat.completions.create({model:e.model,temperature:.01,messages:(0,r.vC)({messages:d,reserveId:!1}),stream:!1}),f=y.choices?.[0].message?.content||"",g=f.indexOf("{"),w=f.lastIndexOf("}");if(-1===g||-1===w)return{rawResponse:f,tokens:await (0,s.SG)(d),arg:{}};let b=f.substring(g,w+1).replace(/(\\n|\\)/g,"").replace(/  /g,"");try{return{rawResponse:f,tokens:await (0,s.SG)(d),arg:h().parse(b)}}catch(e){return console.log(e),{rawResponse:f,tokens:await (0,s.SG)(d),arg:{}}}};n()}catch(e){n(e)}})},57016:(e,t,a)=>{"use strict";a.d(t,{R:()=>n});let n=`<Instruction>
你是一个智能机器人，除了可以回答用户问题外，你还掌握工具的使用能力。有时候，你可以依赖工具的运行结果，来更准确的回答用户。

工具使用了 JSON Schema 的格式声明，其中 toolId 是工具的 description 是工具的描述，parameters 是工具的参数，包括参数的类型和描述，required 是必填参数的列表。

请你根据工具描述，决定回答问题或是使用工具。在完成任务过程中，USER代表用户的输入，TOOL_RESPONSE代表工具运行结果。ASSISTANT 代表你的输出。
你的每次输出都必须以0,1开头，代表是否需要调用工具：
0: 不使用工具，直接回答内容。
1: 使用工具，返回工具调用的参数。

例如：

USER: 你好呀
ANSWER: 0: 你好，有什么可以帮助你的么？
USER: 今天杭州的天气如何
ANSWER: 1: {"toolId":"testToolId",arguments:{"city": "杭州"}}
TOOL_RESPONSE: """
晴天......
"""
ANSWER: 0: 今天杭州是晴天。
USER: 今天杭州的天气适合去哪里玩？
ANSWER: 1: {"toolId":"testToolId2",arguments:{"query": "杭州 天气 去哪里玩"}}
TOOL_RESPONSE: """
晴天. 西湖、灵隐寺、千岛湖……
"""
ANSWER: 0: 今天杭州是晴天，适合去西湖、灵隐寺、千岛湖等地玩。
</Instruction>

现在，我们开始吧！下面是你本次可以使用的工具：

"""
{{toolsPrompt}}
"""

下面是正式的对话内容：

USER: {{question}}
ANSWER: 
`},85520:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Z:()=>b});var r=a(81190),o=a(8487),s=a(56803),i=a(33422),l=a(73945),c=a(93556),d=a(64286),u=a(24385),m=a.n(u),p=a(7110),y=a(935),f=a(49877),g=a(41445),h=e([o,s,d,p,y]);[o,s,d,p,y]=h.then?(await h)():h;let b=async(e,t)=>{let{toolModel:a,toolNodes:n,messages:l,res:u,runtimeNodes:h,detail:v=!1,node:I,stream:x}=e,T=t?.assistantResponses||[],S=n.map(e=>{let t={};return e.toolParams.forEach(e=>{t[e.key]={type:e.valueType||"string",description:e.toolDescription||""}}),{name:e.nodeId,description:e.intro,parameters:{type:"object",properties:t,required:e.toolParams.filter(e=>e.required).map(e=>e.key)}}}),k=await (0,o.uV)({messages:l,maxTokens:a.maxContext-500}),N=k.map(e=>e.role===c.NZ.Assistant&&e.function_call?{...e,function_call:{name:e.function_call?.name,arguments:e.function_call?.arguments}}:e),A=(0,r.c)({timeout:48e4}),P=await A.chat.completions.create({...a?.defaultConfig,model:a.model,temperature:0,stream:x,messages:N,functions:S,function_call:"auto"},{headers:{Accept:"application/json, text/plain, */*"}}),{answer:q,functionCalls:R}=await (async()=>{if(u&&x)return w({res:u,detail:v,toolNodes:n,stream:P});{let e=P.choices?.[0]?.message?.function_call,t=n.find(t=>t.nodeId===e?.name),a=e?[{...e,id:(0,y.Cj)(),toolName:t?.name,toolAvatar:t?.avatar}]:[];return{answer:P.choices?.[0]?.message?.content||"",functionCalls:a}}})(),j=(await Promise.all(R.map(async t=>{if(!t)return;let a=n.find(e=>e.nodeId===t.name);if(!a)return;let r=(()=>{try{return m().parse(t.arguments)}catch(e){return{}}})(),o=await (0,d.$f)({...e,runtimeNodes:h.map(e=>e.nodeId===a.nodeId?{...e,isEntry:!0,inputs:(0,g.B)({params:r,inputs:e.inputs})}:e)}),l="object"==typeof o.toolResponses?JSON.stringify(o.toolResponses,null,2):o.toolResponses?String(o.toolResponses):"none",p={role:c.NZ.Function,name:t.name,content:l};return x&&v&&(0,s.ou)({res:u,event:i.$q.toolResponse,data:JSON.stringify({tool:{id:t.id,toolName:"",toolAvatar:"",params:"",response:l}})}),{toolRunResponse:o,functionCallMsg:p}}))).filter(Boolean),$=j.map(e=>e.toolRunResponse).flat(),E=R[0];if(E&&!u?.closed){let a={role:c.NZ.Assistant,function_call:E},n=[...k,a],r=await (0,p.et)(n,void 0,S),o=[...n,...j.map(e=>e?.functionCallMsg)];x&&v&&(0,s.xc)({res:u,name:I.name});let i=j.map(e=>{let t=e.toolRunResponse.assistantResponses||[];return t}).flat(),l=(0,f.RO)(o),d=l.pop(),m=[...T,...i,...d.value],y=t?t.dispatchFlowResponse.concat($):$,g=$.some(e=>!!e.flowResponses?.find(e=>e.toolStop));return g?{dispatchFlowResponse:y,totalTokens:t?.totalTokens?t.totalTokens+r:r,completeMessages:k,assistantResponses:m}:b({...e,messages:o},{dispatchFlowResponse:y,totalTokens:t?.totalTokens?t.totalTokens+r:r,assistantResponses:m})}{let e={role:c.NZ.Assistant,content:q},a=k.concat(e),n=await (0,p.et)(a,void 0,S),r=(0,f.RO)([e])[0];return{dispatchFlowResponse:t?.dispatchFlowResponse||[],totalTokens:t?.totalTokens?t.totalTokens+n:n,completeMessages:a,assistantResponses:[...T,...r.value]}}};async function w({res:e,detail:t,toolNodes:a,stream:n}){let r=(0,s.qx)({res:e,readStream:n}),o="",c=[],d=(0,y.Cj)();for await(let u of n){if(e.closed){n.controller?.abort();break}let m=u.choices?.[0]?.delta;if(m.content){let e=m?.content||"";o+=e,(0,s.ou)({write:r,event:t?i.$q.answer:void 0,data:(0,l.$q)({text:e})})}else if(m.function_call){let e=m.function_call;if(e?.name){d=(0,y.Cj)();let n=a.find(t=>t.nodeId===e?.name);n&&(e?.arguments===void 0&&(e.arguments=""),c.push({...e,id:d,name:e.name,toolName:n.name,toolAvatar:n.avatar}),t&&(0,s.ou)({write:r,event:i.$q.toolCall,data:JSON.stringify({tool:{id:d,toolName:n.name,toolAvatar:n.avatar,functionName:e.name,params:e.arguments,response:""}})}))}let n=e?.arguments||"",o=c[c.length-1];o&&(o.arguments+=n,t&&(0,s.ou)({write:r,event:i.$q.toolParams,data:JSON.stringify({tool:{id:d,toolName:"",toolAvatar:"",params:n,response:""}})}))}}return o||0!==c.length?{answer:o,functionCalls:c}:Promise.reject("LLM api response empty")}n()}catch(e){n(e)}})},61882:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{P:()=>w});var r=a(88844),o=a(33422),s=a(83249),i=a(44767),l=a(81076),c=a(88068),d=a(49877),u=a(34279),m=a(84569),p=a(85520),y=a(82571),f=a(935),g=a(57016),h=e([l,p,y,f]);[l,p,y,f]=h.then?(await h)():h;let w=async e=>{let{node:{nodeId:t,name:a,outputs:n},runtimeNodes:h,runtimeEdges:w,histories:b,params:{model:v,systemPrompt:I,userChatInput:x,history:T=6}}=e,S=(0,s.DA)(v),k=(0,i.wT)(T,b),N=(0,i.aU)({nodeId:t,edges:w}),A=N.map(e=>{let t=h.find(t=>t.nodeId===e);return t}).filter(Boolean).map(e=>{let t=e?.inputs.filter(e=>!!e.toolDescription)||[];return{...e,toolParams:t}}),P=[...(0,d.vG)(I),...k,{obj:c.LG.Human,value:(0,d.nN)({text:x,files:[]})}],{dispatchFlowResponse:q,totalTokens:R,completeMessages:j=[],assistantResponses:$=[]}=await (async()=>{let t=(0,d.vC)({messages:P,reserveId:!1});if(S.toolChoice)return(0,l.f)({...e,toolNodes:A,toolModel:S,messages:t});if(S.functionCall)return(0,p.Z)({...e,toolNodes:A,toolModel:S,messages:t});let a=t[t.length-1];return"string"!=typeof a.content?Promise.reject("暂时只支持纯文本"):(a.content=(0,f.Fm)(g.R,{question:x}),(0,y.C)({...e,toolNodes:A,toolModel:S,messages:t}))})(),{totalPoints:E,modelName:O}=(0,u.m)({model:v,tokens:R,modelType:s.Mj.llm}),D=q.map(e=>e.flowResponses).flat(),M=E+q.reduce((e,t)=>{let a=t.flowUsages.reduce((e,t)=>e+t.totalPoints,0);return e+a},0),L=q.map(e=>e.flowUsages).flat();return{[r.YQ.answerText]:$.filter(e=>e.text?.content).map(e=>e.text?.content||"").join(""),[o.wk.assistantResponses]:$,[o.wk.nodeResponse]:{totalPoints:M,toolCallTokens:R,model:O,query:x,historyPreview:(0,m.cj)((0,d.RO)(j,!1)),toolDetail:D},[o.wk.nodeDispatchUsages]:[{moduleName:a,totalPoints:E,model:O,tokens:R},...L]}};n()}catch(e){n(e)}})},82571:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{C:()=>b});var r=a(81190),o=a(8487),s=a(56803),i=a(33422),l=a(73945),c=a(93556),d=a(64286),u=a(24385),m=a.n(u),p=a(7110),y=a(935),f=a(49877),g=a(41445),h=e([o,s,d,p,y]);[o,s,d,p,y]=h.then?(await h)():h;let b=async(e,t)=>{let{toolModel:a,toolNodes:n,messages:l,res:u,runtimeNodes:h,detail:I=!1,node:x,stream:T}=e,S=t?.assistantResponses||[],k=JSON.stringify(n.map(e=>{let t={};return e.toolParams.forEach(e=>{t[e.key]={type:"string",description:e.toolDescription||""}}),{toolId:e.nodeId,description:e.intro,parameters:{type:"object",properties:t,required:e.toolParams.filter(e=>e.required).map(e=>e.key)}}})),N=l[l.length-1];if("string"!=typeof N.content)return Promise.reject("暂时只支持纯文本");N.content=(0,y.Fm)(N.content,{toolsPrompt:k});let A=await (0,o.uV)({messages:l,maxTokens:a.maxContext-500}),P=(0,r.c)({timeout:48e4}),q=await P.chat.completions.create({...a?.defaultConfig,model:a.model,temperature:0,stream:T,messages:A},{headers:{Accept:"application/json, text/plain, */*"}}),R=await (async()=>{if(!u||!T)return q.choices?.[0]?.message?.content||"";{let{answer:e}=await w({res:u,detail:I,toolNodes:n,stream:q});return e}})(),j=v(R);if("string"==typeof j){let e={role:c.NZ.Assistant,content:j},a=A.concat(e),n=await (0,p.et)(a,void 0),r=(0,f.RO)([e])[0];return{dispatchFlowResponse:t?.dispatchFlowResponse||[],totalTokens:t?.totalTokens?t.totalTokens+n:n,completeMessages:a,assistantResponses:[...S,...r.value]}}let $=await (async()=>{if(!j)return Promise.reject("tool run error");let t=n.find(e=>e.nodeId===j.name);if(!t)return Promise.reject("tool not found");j.toolName=t.name,j.toolAvatar=t.avatar;let a=(()=>{try{return m().parse(j.arguments)}catch(e){return{}}})();T&&I&&(0,s.ou)({res:u,event:i.$q.toolCall,data:JSON.stringify({tool:{id:j.id,toolName:t.name,toolAvatar:t.avatar,functionName:j.name,params:j.arguments,response:""}})});let r=await (0,d.$f)({...e,runtimeNodes:h.map(e=>e.nodeId===t.nodeId?{...e,isEntry:!0,inputs:(0,g.B)({params:a,inputs:e.inputs})}:e)}),o="object"==typeof r.toolResponses?JSON.stringify(r.toolResponses,null,2):r.toolResponses?String(r.toolResponses):"none";return T&&I&&(0,s.ou)({res:u,event:i.$q.toolResponse,data:JSON.stringify({tool:{id:j.id,toolName:"",toolAvatar:"",params:"",response:o}})}),{moduleRunResponse:r,toolResponsePrompt:o}})();T&&I&&(0,s.xc)({res:u,name:x.name});let E={role:c.NZ.Assistant,function_call:j},O=[...A,E],D=await (0,p.et)(O,void 0),M=[...O,{role:c.NZ.Function,name:j.name,content:$.toolResponsePrompt}],L=$.moduleRunResponse.assistantResponses||[],_=(0,f.RO)(M),C=_.pop(),Q=[...S,...L,...C.value],B=t?t.dispatchFlowResponse.concat($.moduleRunResponse):[$.moduleRunResponse];N.content+=`${R}
TOOL_RESPONSE: """
${$.toolResponsePrompt}
"""
ANSWER: `;let J=$.moduleRunResponse.flowResponses.some(e=>!!e.toolStop);return J?{dispatchFlowResponse:B,totalTokens:t?.totalTokens?t.totalTokens+D:D,completeMessages:A,assistantResponses:Q}:b({...e,messages:l},{dispatchFlowResponse:B,totalTokens:t?.totalTokens?t.totalTokens+D:D,assistantResponses:Q})};async function w({res:e,detail:t,stream:a}){let n=(0,s.qx)({res:e,readStream:a}),r=!1,o="";for await(let c of a){if(e.closed){a.controller?.abort();break}let d=c.choices?.[0]?.delta;if(d.content){let e=d?.content||"";if(o+=e,r)(0,s.ou)({write:n,event:t?i.$q.answer:void 0,data:(0,l.$q)({text:e})});else if(o.length>=3&&(o=o.trim()).startsWith("0")){r=!0;let e=o.indexOf(":");o=o.substring(e+1).trim(),(0,s.ou)({write:n,event:t?i.$q.answer:void 0,data:(0,l.$q)({text:o})})}}}return o?{answer:o.trim()}:Promise.reject("LLM api response empty")}let v=e=>{if(!(e=e.trim()).startsWith("1:"))return e;{let t=e.substring(2).trim();try{let e=m().parse(t);return{id:(0,y.Cj)(),name:e.toolId,arguments:JSON.stringify(e.arguments||e.parameters)}}catch(t){return e}}};n()}catch(e){n(e)}})},51439:(e,t,a)=>{"use strict";a.d(t,{Y:()=>r});var n=a(33422);let r=e=>({[n.wk.nodeResponse]:{toolStop:!0}})},81076:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{f:()=>w});var r=a(81190),o=a(8487),s=a(56803),i=a(33422),l=a(73945),c=a(93556),d=a(64286),u=a(24385),m=a.n(u),p=a(7110),y=a(49877),f=a(41445),g=e([o,s,d,p]);[o,s,d,p]=g.then?(await g)():g;let w=async(e,t)=>{let{toolModel:a,toolNodes:n,messages:l,res:u,runtimeNodes:g,detail:b=!1,node:v,stream:I}=e,x=t?.assistantResponses||[],T=n.map(e=>{let t={};return e.toolParams.forEach(e=>{t[e.key]={type:e.valueType||"string",description:e.toolDescription||""}}),{type:"function",function:{name:e.nodeId,description:e.intro,parameters:{type:"object",properties:t,required:e.toolParams.filter(e=>e.required).map(e=>e.key)}}}}),S=await (0,o.uV)({messages:l,maxTokens:a.maxContext-300}),k=S.map(e=>"assistant"===e.role&&e.tool_calls?{...e,tool_calls:e.tool_calls.map(e=>({id:e.id,type:e.type,function:e.function}))}:e),N=(0,r.c)({timeout:48e4}),A=await N.chat.completions.create({...a?.defaultConfig,model:a.model,temperature:0,stream:I,messages:k,tools:T,tool_choice:"auto"},{headers:{Accept:"application/json, text/plain, */*"}}),{answer:P,toolCalls:q}=await (async()=>{if(u&&I)return h({res:u,detail:b,toolNodes:n,stream:A});{let e=A.choices?.[0]?.message?.tool_calls||[],t=e.map(e=>{let t=n.find(t=>t.nodeId===e.function?.name);return{...e,toolName:t?.name||"",toolAvatar:t?.avatar||""}});return{answer:A.choices?.[0]?.message?.content||"",toolCalls:t}}})(),R=(await Promise.all(q.map(async t=>{let a=n.find(e=>e.nodeId===t.function?.name);if(!a)return;let r=(()=>{try{return m().parse(t.function.arguments)}catch(e){return{}}})(),o=await (0,d.$f)({...e,runtimeNodes:g.map(e=>e.nodeId===a.nodeId?{...e,isEntry:!0,inputs:(0,f.B)({params:r,inputs:e.inputs})}:e)}),l="object"==typeof o.toolResponses?JSON.stringify(o.toolResponses,null,2):o.toolResponses?String(o.toolResponses):"none",p={tool_call_id:t.id,role:c.NZ.Tool,name:t.function.name,content:l};return I&&b&&(0,s.ou)({res:u,event:i.$q.toolResponse,data:JSON.stringify({tool:{id:t.id,toolName:"",toolAvatar:"",params:"",response:l}})}),{toolRunResponse:o,toolMsgParams:p}}))).filter(Boolean),j=R.map(e=>e.toolRunResponse).flat();if(q.length>0&&!u?.closed){let a={role:c.NZ.Assistant,tool_calls:q},n=[...S,a],r=await (0,p.et)(n,T),o=[...n,...R.map(e=>e?.toolMsgParams)];I&&b&&(0,s.xc)({res:u,name:v.name});let i=R.map(e=>{let t=e.toolRunResponse.assistantResponses||[];return t}).flat(),l=(0,y.RO)(o),d=l.pop(),m=[...x,...i,...d.value],f=t?t.dispatchFlowResponse.concat(j):j,g=j.some(e=>!!e.flowResponses?.find(e=>e.toolStop));return g?{dispatchFlowResponse:f,totalTokens:t?.totalTokens?t.totalTokens+r:r,completeMessages:o,assistantResponses:m}:w({...e,messages:o},{dispatchFlowResponse:f,totalTokens:t?.totalTokens?t.totalTokens+r:r,assistantResponses:m})}{let e={role:c.NZ.Assistant,content:P},a=S.concat(e),n=await (0,p.et)(a,T),r=(0,y.RO)([e])[0];return{dispatchFlowResponse:t?.dispatchFlowResponse||[],totalTokens:t?.totalTokens?t.totalTokens+n:n,completeMessages:a,assistantResponses:[...x,...r.value]}}};async function h({res:e,detail:t,toolNodes:a,stream:n}){let r=(0,s.qx)({res:e,readStream:n}),o="",c=[];for await(let d of n){if(e.closed){n.controller?.abort();break}let u=d.choices?.[0]?.delta;if(u?.content){let e=u.content||"";o+=e,(0,s.ou)({write:r,event:t?i.$q.answer:void 0,data:(0,l.$q)({text:e})})}else if(u?.tool_calls?.[0]){let e=u.tool_calls[0];if(e.id){let n=a.find(t=>t.nodeId===e.function?.name);n&&(e.function?.arguments===void 0&&(e.function.arguments=""),c.push({...e,toolName:n.name,toolAvatar:n.avatar}),t&&(0,s.ou)({write:r,event:i.$q.toolCall,data:JSON.stringify({tool:{id:e.id,toolName:n.name,toolAvatar:n.avatar,functionName:e.function.name,params:e.function.arguments,response:""}})}))}let n=u.tool_calls?.[0]?.function?.arguments,o=c[c.length-1];o&&(o.function.arguments+=n,t&&(0,s.ou)({write:r,event:i.$q.toolParams,data:JSON.stringify({tool:{id:o.id,toolName:"",toolAvatar:"",params:n,response:""}})}))}}return o||0!==c.length?{answer:o,toolCalls:c}:Promise.reject("LLM api response empty")}n()}catch(e){n(e)}})},41445:(e,t,a)=>{"use strict";a.d(t,{B:()=>n});let n=({params:e,inputs:t})=>t.map(t=>({...t,value:e[t.key]??t.value}))},31832:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{m:()=>N});var r=a(8487),o=a(88068),s=a(33422),i=a(73945),l=a(81190),c=a(34279),d=a(19781),u=a(93556),m=a(7110),p=a(49877),y=a(39309),f=a(935),g=a(56803),h=a(83249),w=a(44767),b=a(62145),v=a(84569),I=e([r,d,m,f,g,b]);[r,d,m,f,g,b]=I.then?(await I)():I;let N=async e=>{let{res:t,stream:a=!1,detail:n=!1,user:o,histories:i,node:{name:y},inputFiles:f=[],params:{model:g,temperature:b=0,maxToken:I=4e3,history:N=6,quoteQA:A,userChatInput:P,isResponseAnswerText:q=!0,systemPrompt:R="",quoteTemplate:j,quotePrompt:$}}=e;if(!P&&0===f.length)return Promise.reject("Question is empty");a=a&&q;let E=(0,w.wT)(N,i),O=(0,h.DA)(g);if(!O)return Promise.reject("The chat model is undefined, you need to select a chat model.");let{quoteText:D}=await x({quoteQA:A,model:O,quoteTemplate:j});O.censor&&!o.openaiAccount?.key&&await (0,d.m)({text:`${R}
      ${D}
      ${P}
      `});let{filterMessages:M}=await T({model:O,histories:E,quoteQA:A,quoteText:D,quotePrompt:$,userChatInput:P,inputFiles:f,systemPrompt:R}),{max_tokens:L}=await S({model:O,maxToken:I,filterMessages:M});b=+(O.maxTemperature*(b/10)).toFixed(2),b=Math.max(b,.01);let _=(0,l.c)({userKey:o.openaiAccount,timeout:48e4}),C=[...O.defaultSystemChatPrompt?[{role:u.NZ.System,content:O.defaultSystemChatPrompt}]:[],...(0,r._q)(M)];if(0===C.length)return Promise.reject("core.chat.error.Messages empty");let Q=await Promise.all(C.map(async e=>e.role===u.NZ.User?{...e,content:await (0,r.Zb)(e.content)}:e)),B=await _.chat.completions.create({...O?.defaultConfig,model:O.model,temperature:b,max_tokens:L,stream:a,messages:Q},{headers:{Accept:"application/json, text/plain, */*"}}),{answerText:J}=await (async()=>{if(t&&a){let{answer:e}=await k({res:t,detail:n,stream:B});return{answerText:e}}{let e=B.choices?.[0]?.message?.content||"";return{answerText:e}}})(),F=M.concat({role:u.NZ.Assistant,content:J}),U=(0,p.RO)(F),G=await (0,m.SG)(U),{totalPoints:Y,modelName:H}=(0,c.m)({model:g,tokens:G,modelType:h.Mj.llm});return{answerText:J,[s.wk.nodeResponse]:{totalPoints:o.openaiAccount?.key?0:Y,model:H,tokens:G,query:`${P}`,maxToken:L,historyPreview:(0,v.cj)(U),contextTotalLen:F.length},[s.wk.nodeDispatchUsages]:[{moduleName:y,totalPoints:o.openaiAccount?.key?0:Y,model:H,tokens:G}],[s.wk.toolResponses]:J,history:U}};async function x({quoteQA:e=[],model:t,quoteTemplate:a}){let n=await (0,b.n)(e,t.quoteMaxToken),r=n.length>0?`${n.map((e,t)=>(0,f.Fm)(a||y.C[0].value,{q:e.q,a:e.a,source:e.sourceName,sourceId:String(e.sourceId||"UnKnow"),index:t+1}).trim()).join("\n------\n")}`:"";return{quoteText:r}}async function T({quotePrompt:e,quoteText:t,quoteQA:a,histories:n=[],systemPrompt:s,userChatInput:i,inputFiles:l,model:c}){let d=void 0!==a?(0,f.Fm)(e||y.K[0].value,{quote:t,question:i}):i,u=[...(0,p.vG)(s),...n,{obj:o.LG.Human,value:(0,p.nN)({files:l,text:d})}],m=(0,p.vC)({messages:u,reserveId:!1}),g=await (0,r.uV)({messages:m,maxTokens:c.maxContext-300});return{filterMessages:g}}async function S({maxToken:e,model:t,filterMessages:a=[]}){e=Math.min(e,t.maxResponse);let n=t.maxContext,r=await (0,m.et)(a);return(e=r+e>n?n-r:e)<=0&&(e=200),{max_tokens:e}}async function k({res:e,detail:t,stream:a}){let n=(0,g.qx)({res:e,readStream:a}),r="";for await(let o of a){if(e.closed){a.controller?.abort();break}let l=o.choices?.[0]?.delta?.content||"";r+=l,(0,g.ou)({write:n,event:t?s.$q.answer:void 0,data:(0,i.$q)({text:l})})}return r?{answer:r}:Promise.reject("core.chat.Chat API is error or undefined")}n()}catch(e){n(e)}})},59584:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{d:()=>l});var r=a(88844),o=a(18605),s=a(62145),i=e([s]);async function l(e){let{params:{limit:t=1500,...a}}=e,n=Object.values(a).filter(e=>Array.isArray(e)),i=(0,o.o)(n.map(e=>({k:60,list:e})));return{[r.YQ.datasetQuoteQA]:await (0,s.n)(i,t)}}s=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})},12646:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{e:()=>m});var r=a(34279),o=a(83249),s=a(25412),i=a(33422),l=a(44767),c=a(72346),d=a(83783),u=e([s,c,d]);async function m(e){let{teamId:t,histories:a,node:n,params:{datasets:u=[],similarity:m,limit:p=1500,usingReRank:y,searchMode:f,userChatInput:g,datasetSearchUsingExtensionQuery:h,datasetSearchExtensionModel:w,datasetSearchExtensionBg:b}}=e;if(!Array.isArray(u))return Promise.reject("Quote type error");if(0===u.length)return Promise.reject("core.chat.error.Select dataset empty");if(!g)return Promise.reject("core.chat.error.User input empty");let v=h?(0,o.DA)(w):void 0,{concatQueries:I,rewriteQuery:x,aiExtensionResult:T}=await (0,c.g)({query:g,extensionModel:v,extensionBg:b,histories:(0,l.wT)(6,a)}),S=(0,o.BA)(u[0]?.vectorModel?.model),{searchRes:k,tokens:N,usingSimilarityFilter:A,usingReRank:P}=await (0,s.n)({teamId:t,reRankQuery:`${x}`,queries:I,model:S.model,similarity:m,limit:p,datasetIds:u.map(e=>e.datasetId),searchMode:f,usingReRank:y&&await (0,d.AX)(t)}),{totalPoints:q,modelName:R}=(0,r.m)({model:S.model,tokens:N,modelType:o.Mj.vector}),j={totalPoints:q,query:I.join("\n"),model:R,tokens:N,similarity:A?m:void 0,limit:p,searchMode:f,searchUsingReRank:P,quoteList:k},$=[{totalPoints:q,moduleName:n.name,model:R,tokens:N}];if(T){let{totalPoints:e,modelName:t}=(0,r.m)({model:T.model,tokens:T.tokens,modelType:o.Mj.llm});j.totalPoints+=e,j.tokens=T.tokens,j.extensionModel=t,j.extensionResult=T.extensionQueries?.join("\n")||JSON.stringify(T.extensionQueries),$.push({totalPoints:e,moduleName:"core.module.template.Query extension",model:t,tokens:T.tokens})}return{quoteQA:k,[i.wk.nodeResponse]:j,nodeDispatchUsages:$,[i.wk.toolResponses]:k.map(e=>({id:e.id,text:`${e.q}
${e.a}`.trim()}))}}[s,c,d]=u.then?(await u)():u,n()}catch(e){n(e)}})},64286:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{$f:()=>$});var r=a(88844),o=a(33422),s=a(81413),i=a(935),l=a(56803),c=a(3126),d=a(9896),u=a(31832),m=a(12646),p=a(59584),y=a(90291),f=a(62475),g=a(59558),h=a(53701),w=a(55260),b=a(85090),v=a(98365),I=a(44765),x=a(47573),T=a(44767),S=a(73945),k=a(61882),N=a(88068),A=a(51439),P=a(61165),q=a(73001),R=a(75258),j=e([i,l,u,m,p,y,f,g,h,w,b,v,k,P]);[i,l,u,m,p,y,f,g,h,w,b,v,k,P]=j.then?(await j)():j;let E={[s.Jm.workflowStart]:d.K,[s.Jm.answerNode]:y.A,[s.Jm.chatNode]:u.m,[s.Jm.datasetSearchNode]:m.e,[s.Jm.datasetConcatNode]:p.d,[s.Jm.classifyQuestion]:f.l,[s.Jm.contentExtract]:g.m,[s.Jm.httpRequest468]:h.y,[s.Jm.runApp]:w.k,[s.Jm.pluginModule]:v.A,[s.Jm.pluginInput]:I.c,[s.Jm.pluginOutput]:x.b,[s.Jm.queryExtension]:b.z,[s.Jm.tools]:k.P,[s.Jm.stopTool]:A.Y,[s.Jm.lafModule]:P.i,[s.Jm.ifElseNode]:q.O,[s.Jm.systemConfig]:R.t,[s.Jm.emptyNode]:()=>Promise.resolve(),[s.Jm.globalVariable]:()=>Promise.resolve()};async function $({res:e,runtimeNodes:t=[],runtimeEdges:a=[],histories:n=[],variables:d={},user:u,stream:m=!1,detail:p=!1,...y}){let f;m&&e&&(e.setHeader("Content-Type","text/event-stream;charset=utf-8"),e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("X-Accel-Buffering","no"),e.setHeader("Cache-Control","no-cache, no-transform")),d={...function({timezone:e}){return{cTime:(0,c.iE)(e)}}({timezone:u.timezone}),...d};let g=[],h=[],w=[],b=Date.now(),v=[];function I(e){let t=a.filter(t=>t.target===e.nodeId);t.forEach(e=>{e.status="waiting"})}async function x(r){if(e?.closed||y.maxRunTimes<=0)return[];e&&m&&p&&r.showStatus&&function({res:e,status:t,name:a}){a&&(0,l.xc)({res:e,name:a})}({res:e,name:r.name,status:"running"});let s=function(e){let a={};return e.inputs.forEach(e=>{let n=(0,i.Fm)(e.value,d);n=(0,S.q5)({value:n,nodes:t,variables:d}),a[e.key]=(0,T.$9)(n,e.valueType)}),a}(r),c={...y,res:e,variables:d,histories:n,user:u,stream:m,detail:p,node:r,runtimeNodes:t,runtimeEdges:a,params:s},f=await (async()=>E[r.flowNodeType]?E[r.flowNodeType](c):{})(),g=(()=>{if(f[o.wk.nodeResponse])return{nodeId:r.nodeId,moduleName:r.name,moduleType:r.flowNodeType,...f[o.wk.nodeResponse]}})();return r.outputs.forEach(e=>{e.required&&void 0===f[e.key]&&(f[e.key]=(0,T.$9)(e.defaultValue,e.valueType))}),I(r),{node:r,result:{...f,[o.wk.nodeResponse]:g}}}async function k(e){let t=a.filter(t=>t.source===e.nodeId);return I(e),{node:e,result:{[o.wk.skipHandleId]:t.map(e=>e.sourceHandle)}}}let A=t.filter(e=>e.isEntry);t.forEach(e=>{e.isEntry=!1}),await function e(n=[]){return Promise.all(n.map(e=>{let t=(0,S.u6)({node:e,runtimeEdges:a});return"run"===t?x(e):"skip"===t?k(e):[]})).then(n=>{let s=n.flat();if(0===s.length)return;let i=s.map(e=>(function(e,n={}){(function({inputs:e=[]},{answerText:t="",responseData:a,nodeDispatchUsages:n,toolResponses:o,assistantResponses:s}){let i=Date.now();if(a&&g.push({...a,runningTime:+((i-b)/1e3).toFixed(2)}),n&&(w=w.concat(n),y.maxRunTimes-=n.length),void 0!==o){if(Array.isArray(o)&&0===o.length||"object"==typeof o&&0===Object.keys(o).length)return;f=o}if(s)h=h.concat(s);else if(t){let a=e.find(e=>e.key===r.YS.aiChatIsResponseText)?.value??!0;a&&h.push({type:N.Dl.text,text:{content:t}})}b=i})(e,n),e.outputs.forEach(e=>{void 0!==n[e.key]&&(e.value=n[e.key])});let s=n[o.wk.skipHandleId]||[],i=(0,S._Y)(a).filter(t=>t.source===e.nodeId);i.forEach(e=>{s.includes(e.sourceHandle)?e.status="skipped":e.status="active"});let l=t.filter(e=>i.some(t=>t.target===e.nodeId));return"debug"===y.mode?(v=v.concat(l),[]):l})(e.node,e.result)).flat(),l=i.filter((e,t,a)=>a.findIndex(t=>t.nodeId===e.nodeId)===t);return e(l)})}(A);let P=t.find(e=>e.flowNodeType===s.Jm.pluginOutput);return P&&"debug"!==y.mode&&await x(P),{flowResponses:g,flowUsages:w,debugResponse:{finishedNodes:t,finishedEdges:a,nextStepRunNodes:v},[o.wk.assistantResponses]:O(h),[o.wk.toolResponses]:f}}let O=e=>{let t=[];for(let a=0;a<e.length;a++){let n=e[a];if(n.type===N.Dl.text){let e=n.text?.content||"",a=t[t.length-1];if(a&&a.type===N.Dl.text&&a.text?.content){a.text.content+=e;continue}}t.push(n)}return t};n()}catch(e){n(e)}})},75258:(e,t,a)=>{"use strict";a.d(t,{t:()=>n});let n=e=>{let{variables:t}=e;return t}},9896:(e,t,a)=>{"use strict";a.d(t,{K:()=>n});let n=e=>{let{variables:{userChatInput:t},params:{userChatInput:a}}=e;return{userChatInput:a||t}}},98365:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{A:()=>y});var r=a(64286),o=a(81413),s=a(88844),i=a(33422),l=a(24365),c=a(66610),d=a(73945),u=a(41445),m=a(935),p=e([r,l,c,m]);[r,l,c,m]=p.then?(await p)():p;let y=async e=>{let{node:{pluginId:t},mode:a,teamId:n,tmbId:p,params:y}=e;if(!t)return Promise.reject("pluginId can not find");await (0,c.O)({id:t,teamId:n,tmbId:p});let f=await (0,l.n7)(t),g=f.nodes.find(e=>e.flowNodeType===o.Jm.pluginInput);if(!g)return Promise.reject("Plugin error, It has no set input.");let h=g.inputs.find(e=>e.key===s.YS.addInputParam),w=(()=>{if(!h)return y;let e={[s.YS.addInputParam]:{}};for(let t in y){if(t===s.YS.addInputParam)continue;let a=g.inputs.find(e=>e.key===t);a?e[t]=y[t]:e[s.YS.addInputParam][t]=y[t]}return e})();if(h)for(let e in w)e!==s.YS.addInputParam&&(w[e]=(0,m.Fm)(w[e],w[s.YS.addInputParam]));let{flowResponses:b,flowUsages:v,assistantResponses:I}=await (0,r.$f)({...e,runtimeNodes:(0,d.v_)(f.nodes,(0,d.I2)(f.nodes)).map(e=>e.flowNodeType===o.Jm.pluginInput?{...e,showStatus:!1,inputs:(0,u.B)({inputs:e.inputs,params:w})}:{...e,showStatus:!1}),runtimeEdges:(0,d.Zs)(f.edges)}),x=b.find(e=>e.moduleType===o.Jm.pluginOutput);return x&&(x.moduleLogo=f.avatar),{assistantResponses:I,[i.wk.nodeResponse]:{moduleLogo:f.avatar,totalPoints:b.reduce((e,t)=>e+(t.totalPoints||0),0),pluginOutput:x?.pluginOutput,pluginDetail:"test"===a&&f.teamId===n?b.filter(e=>{let t=[o.Jm.pluginOutput];return!t.includes(e.moduleType)}):void 0},[i.wk.nodeDispatchUsages]:[{moduleName:f.name,totalPoints:v.reduce((e,t)=>e+(t.totalPoints||0),0),model:f.name,tokens:0}],[i.wk.toolResponses]:x?.pluginOutput?x.pluginOutput:{},...x?x.pluginOutput:{}}};n()}catch(e){n(e)}})},44765:(e,t,a)=>{"use strict";a.d(t,{c:()=>n});let n=e=>{let{params:t}=e;return t}},47573:(e,t,a)=>{"use strict";a.d(t,{b:()=>r});var n=a(33422);let r=e=>{let{params:t}=e;return{[n.wk.nodeResponse]:{totalPoints:0,pluginOutput:t}}}},90291:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{A:()=>c});var r=a(33422),o=a(56803),s=a(73945),i=a(88844),l=e([o]);o=(l.then?(await l)():l)[0];let c=e=>{let{res:t,detail:a,stream:n,params:{text:l=""}}=e,c="string"==typeof l?l:JSON.stringify(l,null,2),d=`
${c}`;return t&&n&&(0,o.ou)({res:t,event:a?r.$q.fastAnswer:void 0,data:(0,s.$q)({text:d})}),{[i.YQ.answerText]:d,[r.wk.nodeResponse]:{textOutput:c}}};n()}catch(e){n(e)}})},53701:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{y:()=>h});var r=a(88844),o=a(33422),s=a(99648),i=a(44767),l=a(47676),c=a(7161),d=a(66743),u=a(56803),m=a(73945),p=e([s,d,u]);[s,d,u]=p.then?(await p)():p;let g="UNDEFINED_SIGN",h=async e=>{let{res:t,detail:a,appId:n,chatId:s,responseChatItemId:l,variables:p,node:{outputs:h},histories:w,params:{system_httpMethod:b="POST",system_httpReqUrl:v,system_httpHeader:I,system_httpParams:x=[],system_httpJsonBody:T,[r.YS.addInputParam]:S,...k}}=e;if(!v)return Promise.reject("Http url is empty");let N={appId:n,chatId:s,responseChatItemId:l,...p,histories:w.slice(-10),...k,...S},A={[r.YS.addInputParam]:N,...N};v=f(v,A);let P=await (()=>{try{if(!I||0===I.length)return{};return I.reduce((e,t)=>{let a=f(t.key,A),n=f(t.value,A);return e[a]=(0,i.$9)(n,r.o7.string),e},{})}catch(e){return Promise.reject("Header 为非法 JSON 格式")}})(),q=x.reduce((e,t)=>{let a=f(t.key,A),n=f(t.value,A);return e[a]=(0,i.$9)(n,r.o7.string),e},{}),R=await (()=>{if(!T)return{};try{T=f(T,A);

/*
 * feat: http 非json请求体不处理
 */
if(P['Content-Type']?.includes('text/plain')) return T;

let e=JSON.parse(T),t=function e(t){for(let a in t)t[a]===g?t[a]=void 0:Array.isArray(t[a])?t[a]=t[a].map(t=>t===g?void 0:("object"==typeof t&&e(t),t)):"object"==typeof t[a]&&e(t[a]);return t}(e);return t}catch(e){return console.log(e),Promise.reject(`Invalid JSON body: ${T}`)}})();try{let{formatResponse:e,rawResponse:n}=await y({method:b,url:v,headers:P,body:R,params:q}),s={};for(let t in e){let a=h.find(e=>e.key===t);a&&(s[t]=(0,i.$9)(e[t],a.valueType))}return"string"==typeof e[r.YQ.answerText]&&(0,u.ou)({res:t,event:a?o.$q.fastAnswer:void 0,data:(0,m.$q)({text:e[r.YQ.answerText]})}),{[o.wk.nodeResponse]:{totalPoints:0,params:Object.keys(q).length>0?q:void 0,body:Object.keys(R).length>0?R:void 0,headers:Object.keys(P).length>0?P:void 0,httpResult:n},[o.wk.toolResponses]:Object.keys(s).length>0?s:n,[r.YQ.httpRawResponse]:n,...s}}catch(e){return c.B.error("Http request error",e),{[r.YQ.failed]:!0,[o.wk.nodeResponse]:{totalPoints:0,params:Object.keys(q).length>0?q:void 0,body:Object.keys(R).length>0?R:void 0,headers:Object.keys(P).length>0?P:void 0,httpResult:{error:function(e){return{message:e?.message,name:e?.name,method:e?.config?.method,baseURL:e?.config?.baseURL,url:e?.config?.url,code:e?.code,status:e?.status}}(e)}},[r.YQ.httpRawResponse]:(0,d.v)(e)}}};async function y({method:e,url:t,headers:a,body:n,params:r}){let{data:o}=await (0,s.default)({method:e,baseURL:`http://${l.wm}`,url:t,headers:{"Content-Type":"application/json",...a},timeout:12e4,params:r,data:["POST","PUT","PATCH"].includes(e)?n:void 0}),i=(e,t="")=>{let a={};if(Array.isArray(e))for(let n=0;n<e.length;n++)a[`${t}[${n}]`]=e[n],Array.isArray(e[n])?a={...a,...i(e[n],`${t}[${n}]`)}:"object"==typeof e[n]&&(a={...a,...i(e[n],`${t}[${n}].`)});else if("object"==typeof e)for(let n in e)a[`${t}${n}`]=e[n],Array.isArray(e[n])?a={...a,...i(e[n],`${t}${n}`)}:"object"==typeof e[n]&&(a={...a,...i(e[n],`${t}${n}.`)});return a};return{formatResponse:"object"!=typeof o||Array.isArray(o)?{}:i(o),rawResponse:o}}function f(e,t){for(let[a,n]of Object.entries(t))if(void 0===n)e=e.replace(RegExp(`{{${a}}}`,"g"),g);else{let t=JSON.stringify(n),r=t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1):t;e=e.replace(RegExp(`{{${a}}}`,"g"),r)}return e||""}n()}catch(e){n(e)}})},85090:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{z:()=>m});var r=a(88844),o=a(33422),s=a(83249),i=a(34279),l=a(57803),c=a(44767),d=a(935),u=e([l,d]);[l,d]=u.then?(await u)():u;let m=async({histories:e,node:t,params:{model:a,systemPrompt:n,history:u,userChatInput:m}})=>{if(!m)return Promise.reject("Question is empty");let p=(0,s.DA)(a),y=(0,c.wT)(u,e),{extensionQueries:f,tokens:g}=await (0,l.H)({chatBg:n,query:m,histories:y,model:p.model});f.unshift(m);let{totalPoints:h,modelName:w}=(0,i.m)({model:p.model,tokens:g,modelType:s.Mj.llm}),b=new Set,v=f.filter(e=>{let t=(0,d.ck)(e.replace(/[^\p{L}\p{N}]/gu,""));return!b.has(t)&&(b.add(t),!0)});return{[o.wk.nodeResponse]:{totalPoints:h,model:w,tokens:g,query:m,textOutput:JSON.stringify(v)},[o.wk.nodeDispatchUsages]:[{moduleName:t.name,totalPoints:h,model:w,tokens:g}],[r.YQ.text]:JSON.stringify(v)}};n()}catch(e){n(e)}})},55260:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{k:()=>p});var r=a(64286),o=a(65306),s=a(56803),i=a(88068),l=a(33422),c=a(73945),d=a(44767),u=a(49877),m=e([r,s]);[r,s]=m.then?(await m)():m;let p=async e=>{let{res:t,teamId:a,stream:n,detail:m,histories:p,inputFiles:y,params:{userChatInput:f,history:g,app:h}}=e;if(Date.now(),!f)return Promise.reject("Input is empty");let w=await o.p.findOne({_id:h.id,teamId:a});if(!w)return Promise.reject("App not found");t&&n&&(0,s.ou)({res:t,event:m?l.$q.answer:void 0,data:(0,c.$q)({text:"\n"})});let b=(0,d.wT)(g,p),{flowResponses:v,flowUsages:I,assistantResponses:x}=await (0,r.$f)({...e,appId:h.id,runtimeNodes:(0,c.v_)(w.modules,(0,c.I2)(w.modules)),runtimeEdges:(0,c.Zs)(w.edges),histories:b,inputFiles:y,variables:{...e.variables,userChatInput:f}}),T=b.concat([{obj:i.LG.Human,value:(0,u.nN)({files:y,text:f})},{obj:i.LG.AI,value:x}]),{text:S}=(0,u.z2)(x);return{[l.wk.nodeResponse]:{moduleLogo:w.avatar,query:f,textOutput:S,totalPoints:v.reduce((e,t)=>e+(t.totalPoints||0),0)},[l.wk.nodeDispatchUsages]:[{moduleName:w.name,totalPoints:I.reduce((e,t)=>e+(t.totalPoints||0),0)}],answerText:S,history:T}};n()}catch(e){n(e)}})},73001:(e,t,a)=>{"use strict";a.d(t,{O:()=>i});var n,r=a(33422);(function(e){e.equalTo="equalTo",e.notEqual="notEqual",e.isEmpty="isEmpty",e.isNotEmpty="isNotEmpty",e.include="include",e.notInclude="notInclude",e.startWith="startWith",e.endWith="endWith",e.greaterThan="greaterThan",e.greaterThanOrEqualTo="greaterThanOrEqualTo",e.lessThan="lessThan",e.lessThanOrEqualTo="lessThanOrEqualTo",e.lengthEqualTo="lengthEqualTo",e.lengthNotEqualTo="lengthNotEqualTo",e.lengthGreaterThan="lengthGreaterThan",e.lengthGreaterThanOrEqualTo="lengthGreaterThanOrEqualTo",e.lengthLessThan="lengthLessThan",e.lengthLessThanOrEqualTo="lengthLessThanOrEqualTo"})(n||(n={})),n.isEmpty,n.isNotEmpty,n.equalTo,n.notEqual,n.include,n.notInclude,n.startWith,n.endWith,n.isEmpty,n.isNotEmpty,n.equalTo,n.notEqual,n.greaterThan,n.greaterThanOrEqualTo,n.lessThan,n.lessThanOrEqualTo,n.isEmpty,n.isNotEmpty,n.equalTo,n.isEmpty,n.isNotEmpty,n.include,n.notInclude,n.lengthEqualTo,n.lengthNotEqualTo,n.lengthGreaterThan,n.lengthGreaterThanOrEqualTo,n.lengthLessThan,n.lengthLessThanOrEqualTo,n.isEmpty,n.isNotEmpty,n.isEmpty,n.isNotEmpty,n.equalTo,n.notEqual,n.include,n.notInclude,n.startWith,n.endWith,n.greaterThan,n.greaterThanOrEqualTo,n.lessThan,n.lessThanOrEqualTo,n.lengthEqualTo,n.lengthNotEqualTo,n.lengthGreaterThan,n.lengthGreaterThanOrEqualTo,n.lengthLessThan,n.lengthLessThanOrEqualTo;var o=a(27378),s=a(73945);let i=async e=>{let{params:t,runtimeNodes:a,variables:i,node:{nodeId:l}}=e,{condition:c,ifElseList:d}=t,u=d.map(e=>{let{variable:t,condition:r,value:o}=e,l=(0,s.q5)({value:t,variables:i,nodes:a});return function(e,t,a){let r={[n.isEmpty]:()=>!t,[n.isNotEmpty]:()=>!!t,[n.equalTo]:()=>t===a,[n.notEqual]:()=>t!==a,[n.greaterThan]:()=>Number(t)>Number(a),[n.lessThan]:()=>Number(t)<Number(a),[n.greaterThanOrEqualTo]:()=>Number(t)>=Number(a),[n.lessThanOrEqualTo]:()=>Number(t)<=Number(a),[n.include]:()=>t?.includes(a),[n.notInclude]:()=>!t?.includes(a),[n.startWith]:()=>t?.startsWith(a),[n.endWith]:()=>t?.endsWith(a),[n.lengthEqualTo]:()=>t?.length===Number(a),[n.lengthNotEqualTo]:()=>t?.length!==Number(a),[n.lengthGreaterThan]:()=>t?.length>Number(a),[n.lengthGreaterThanOrEqualTo]:()=>t?.length>=Number(a),[n.lengthLessThan]:()=>t?.length<Number(a),[n.lengthLessThanOrEqualTo]:()=>t?.length<=Number(a)};return(r[e]||(()=>!1))()}(r,l,o||"")}),m="AND"===c?u.every(Boolean):u.some(Boolean);return{[r.wk.nodeResponse]:{totalPoints:0,ifElseResult:m?"IF":"ELSE"},[r.wk.skipHandleId]:m?[(0,o.xH)(l,"source","ELSE")]:[(0,o.xH)(l,"source","IF")]}}},61165:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{i:()=>m});var r=a(88844),o=a(33422),s=a(99648),i=a(44767),l=a(47676),c=a(7161),d=e([s]);s=(d.then?(await d)():d)[0];let m=async e=>{let{appId:t,chatId:a,responseChatItemId:n,variables:s,node:{outputs:l},histories:d,params:{system_httpReqUrl:m,[r.YS.addInputParam]:p,...y}}=e;if(!m)return Promise.reject("Http url is empty");let f={appId:t,chatId:a,responseChatItemId:n,...s,...y};m=function(e,t){for(let[a,n]of Object.entries(t))if(void 0===n)e=e.replace(RegExp(`{{${a}}}`,"g"),"UNDEFINED_SIGN");else{let t=JSON.stringify(n),r=t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1):t;e=e.replace(RegExp(`{{${a}}}`,"g"),r)}return e||""}(m,f);let g={systemParams:{appId:t,chatId:a,responseChatItemId:n,histories:d.slice(0,10)},variables:s,...p,...y};try{let{formatResponse:e,rawResponse:t}=await u({method:"POST",url:m,body:g}),a={};for(let t in e){let n=l.find(e=>e.key===t);n&&(a[t]=(0,i.$9)(e[t],n.valueType))}return{assistantResponses:[],[o.wk.nodeResponse]:{totalPoints:0,body:Object.keys(g).length>0?g:void 0,httpResult:t},[o.wk.toolResponses]:t,[r.YQ.httpRawResponse]:t,...a}}catch(e){return c.B.error("Http request error",e),{[r.YQ.failed]:!0,[o.wk.nodeResponse]:{totalPoints:0,body:Object.keys(g).length>0?g:void 0,httpResult:{error:function(e){return{message:e?.message,name:e?.name,method:e?.config?.method,baseURL:e?.config?.baseURL,url:e?.config?.url,code:e?.code,status:e?.status}}(e)}}}}};async function u({method:e,url:t,body:a}){let{data:n}=await (0,s.default)({method:e,baseURL:`http://${l.wm}`,url:t,headers:{"Content-Type":"application/json"},data:a}),r=(e,t="")=>{let a={};if(Array.isArray(e))for(let n=0;n<e.length;n++)a[`${t}[${n}]`]=e[n],Array.isArray(e[n])?a={...a,...r(e[n],`${t}[${n}]`)}:"object"==typeof e[n]&&(a={...a,...r(e[n],`${t}[${n}].`)});else if("object"==typeof e)for(let n in e)a[`${t}${n}`]=e[n],Array.isArray(e[n])?a={...a,...r(e[n],`${t}${n}`)}:"object"==typeof e[n]&&(a={...a,...r(e[n],`${t}${n}.`)});return a};return{formatResponse:"object"!=typeof n||Array.isArray(n)?{}:r(n),rawResponse:n}}n()}catch(e){n(e)}})},44767:(e,t,a)=>{"use strict";a.d(t,{$9:()=>s,aU:()=>r,wT:()=>o});var n=a(88844);let r=({nodeId:e,edges:t})=>t.filter(t=>t.source===e&&t.targetHandle===n.YQ.selectedTools).map(e=>e.target),o=(e,t=[])=>e?"number"==typeof e?t.slice(-e):Array.isArray(e)?e:[]:[],s=(e,t)=>{if(void 0!==e){if("string"===t)return"object"!=typeof e?String(e):JSON.stringify(e);if("number"===t)return Number(e);if("boolean"===t)return!!e;try{if(t===n.o7.datasetQuote&&!Array.isArray(e)||t===n.o7.selectDataset&&!Array.isArray(e))return JSON.parse(e)}catch(e){}return e}}},62145:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{n:()=>s});var r=a(7110),o=e([r]);r=(o.then?(await o)():o)[0];let s=async(e,t)=>{let a=[],n=0;for(let o=0;o<e.length;o++){let s=e[o];if((n+=await (0,r.BM)(s.q+s.a))>t+500||(a.push(s),n>t))break}return 0===a.length?e.slice(0,1):a};n()}catch(e){n(e)}})},66610:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{O:()=>p,_:()=>m});var r=a(38773),o=a(17546),s=a(3036),i=a(36962),l=a(3408),c=a(24365),d=a(85686),u=e([r,o,c]);async function m({pluginId:e,per:t="owner",...a}){let n=await (0,r.vW)(a),{tmbId:c,teamId:d}=n,{role:u}=await (0,o.yJ)({tmbId:c}),{plugin:m,isOwner:p,canWrite:y}=await (async()=>{let a=await i.S.findOne({_id:e,teamId:d});if(!a)throw Error(l.o.unExist);let n=String(a.tmbId)===c||u===s.nk.owner;return("w"!==t||n)&&("owner"!==t||n)?{plugin:a,isOwner:n,canWrite:n}:Promise.reject(l.o.unAuth)})();return{...n,plugin:m,isOwner:p,canWrite:y}}async function p({id:e,teamId:t,tmbId:a}){let{source:n,pluginId:r}=await (0,c.hX)(e);if(n===d.C9.community)return!0;if(n===d.C9.personal){let{role:e}=await (0,o.yJ)({tmbId:a}),n=await i.S.findOne({_id:r,teamId:t});if(!n)return Promise.reject(l.o.unExist)}return!0}[r,o,c]=u.then?(await u)():u,n()}catch(e){n(e)}})},83783:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{AX:()=>f,TO:()=>y,eK:()=>u,h7:()=>p,qd:()=>m});var r=a(6218),o=a(62845),s=a(65306);a(36962);var i=a(53457),l=a(89645),c=a(77490),d=e([r,o]);[r,o]=d.then?(await d)():d;let u=async({teamId:e,insertLen:t=0})=>{let[{standardConstants:a,totalPoints:n,usedPoints:s,datasetMaxSize:i},l]=await Promise.all([(0,o.pW)({teamId:e}),(0,r.tB)(e)]);if(a){if(l+t>=i)return Promise.reject(c.T.datasetSizeNotEnough);if(s>=n)return Promise.reject(c.T.aiPointsNotEnough)}},m=async e=>{let{standardConstants:t,totalPoints:a,usedPoints:n}=await (0,o.pW)({teamId:e});if(t)return n>=a?Promise.reject(c.T.aiPointsNotEnough):{totalPoints:a,usedPoints:n}},p=async e=>{let[{standardConstants:t},a]=await Promise.all([(0,o.h_)({teamId:e}),i.r.countDocuments({teamId:e,type:{$ne:l.ie.folder}})]);if(t&&a>=t.maxDatasetAmount)return Promise.reject(c.T.datasetAmountNotEnough)},y=async e=>{let[{standardConstants:t},a]=await Promise.all([(0,o.h_)({teamId:e}),s.p.count({teamId:e})]);if(t&&a>=t.maxAppAmount)return Promise.reject(c.T.appAmountNotEnough)},f=async e=>{let{standardConstants:t}=await (0,o.h_)({teamId:e});return!t||!!t?.permissionReRank};n()}catch(e){n(e)}})},17546:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Dz:()=>u,hP:()=>m,yJ:()=>d});var r=a(48079),o=a(3036),s=a(63442),i=a(365),l=e([s,i]);async function c(e){let t=await s.d.findOne(e).populate("teamId");return t?{userId:String(t.userId),teamId:String(t.teamId._id),teamName:t.teamId.name,memberName:t.name,avatar:t.teamId.avatar,balance:t.teamId.balance,tmbId:String(t._id),teamDomain:t.teamId?.teamDomain,role:t.role,status:t.status,defaultTeam:t.defaultTeam,canWrite:t.role!==o.nk.visitor,lafAccount:t.teamId.lafAccount}:Promise.reject("member not exist")}async function d({tmbId:e}){return e?c({_id:new r.Types.ObjectId(String(e)),status:o._F}):Promise.reject("tmbId or userId is required")}async function u({userId:e}){return e?c({userId:new r.Types.ObjectId(e),defaultTeam:!0}):Promise.reject("tmbId or userId is required")}async function m({userId:e,teamName:t="My Team",avatar:a="/icon/logo.svg",balance:n,session:l}){let c=await s.d.findOne({userId:new r.Types.ObjectId(e),defaultTeam:!0});if(c)console.log("default team exist",e),await i.a.findByIdAndUpdate(c.teamId,{$set:{...void 0!==n&&{balance:n}}});else{let[{_id:r}]=await i.a.create([{ownerId:e,name:t,avatar:a,balance:n,createTime:new Date}],{session:l});await s.d.create([{teamId:r,userId:e,name:"Owner",role:o.nk.owner,status:o.lH.active,createTime:new Date,defaultTeam:!0}],{session:l}),console.log("create default team",e)}}[s,i]=l.then?(await l)():l,n()}catch(e){n(e)}})},63442:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{d:()=>m});var r=a(48079),o=a(80759),s=a(3036),i=e([o]);o=(i.then?(await i)():i)[0];let{Schema:l,model:c,models:d}=r.connectionMongo,u=new l({teamId:{type:l.Types.ObjectId,ref:s.NG,required:!0},userId:{type:l.Types.ObjectId,ref:o.B,required:!0},name:{type:String,default:"Member"},role:{type:String,enum:Object.keys(s.M8)},status:{type:String,enum:Object.keys(s.f2)},createTime:{type:Date,default:()=>new Date},defaultTeam:{type:Boolean,default:!1}});try{u.index({teamId:1},{background:!0}),u.index({userId:1},{background:!0})}catch(e){console.log(e)}let m=d[s.T5]||c(s.T5,u);n()}catch(e){n(e)}})},365:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{a:()=>m});var r=a(48079),o=a(80759),s=a(3036),i=e([o]);o=(i.then?(await i)():i)[0];let{Schema:l,model:c,models:d}=r.connectionMongo,u=new l({name:{type:String,required:!0},ownerId:{type:l.Types.ObjectId,ref:o.B},avatar:{type:String,default:"/icon/logo.svg"},createTime:{type:Date,default:()=>Date.now()},balance:{type:Number,default:0},teamDomain:{type:String},limit:{lastExportDatasetTime:{type:Date},lastWebsiteSyncTime:{type:Date}},lafAccount:{token:{type:String},appid:{type:String},pat:{type:String}}});try{u.index({name:1}),u.index({ownerId:1})}catch(e){console.log(e)}let m=d[s.NG]||c(s.NG,u);n()}catch(e){n(e)}})},11339:(e,t,a)=>{"use strict";a.d(t,{b:()=>u});var n=a(48079),r=a(3036),o=a(29384);let{Schema:s,model:i,models:l}=n.connectionMongo,c="team.subscriptions",d=new s({teamId:{type:s.Types.ObjectId,ref:r.NG,required:!0},type:{type:String,enum:Object.keys(o.rD),required:!0},status:{type:String,enum:Object.keys(o.$X),required:!0},startTime:{type:Date,default:()=>new Date},expiredTime:{type:Date,required:!0},price:{type:Number,required:!0},currentMode:{type:String,enum:Object.keys(o.jh)},nextMode:{type:String,enum:Object.keys(o.jh)},currentSubLevel:{type:String,enum:Object.keys(o.gj)},nextSubLevel:{type:String,enum:Object.keys(o.gj)},totalPoints:{type:Number},pointPrice:{type:Number},surplusPoints:{type:Number},currentExtraDatasetSize:{type:Number}});try{d.index({teamId:1,type:1,expiredTime:-1}),d.index({type:1,currentSubLevel:1,expiredTime:-1})}catch(e){console.log(e)}let u=l[c]||i(c,d)},62845:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{h_:()=>m,pW:()=>y});var r=a(29384),o=a(11339),s=a(6218),i=a(1635),l=a.n(i),c=a(54538),d=a.n(c),u=e([s]);s=(u.then?(await u)():u)[0];let m=async({teamId:e})=>{let t=global.subPlans?.standard,a=await o.b.findOne({teamId:e,type:r.cc.standard}).lean();return{[r.cc.standard]:a,standardConstants:a?.currentSubLevel&&t?t[a.currentSubLevel]:void 0}},p=async({teamId:e,session:t})=>{let a=global?.subPlans?.standard?.free?.totalPoints||100,n=await o.b.findOne({teamId:e,type:r.cc.standard});return n?(n.status=r.lo.active,n.currentMode=r.F8.month,n.nextMode=r.F8.month,n.startTime=new Date,n.expiredTime=d()(new Date,1),n.currentSubLevel=r.Yn.free,n.nextSubLevel=r.Yn.free,n.price=0,n.pointPrice=0,n.totalPoints=a,n.surplusPoints=n.surplusPoints&&n.surplusPoints<0?n.surplusPoints+a:a,n.save({session:t})):o.b.create([{teamId:e,type:r.cc.standard,status:r.lo.active,currentMode:r.F8.month,nextMode:r.F8.month,startTime:new Date,expiredTime:d()(new Date,1),price:0,pointPrice:0,currentSubLevel:r.Yn.free,nextSubLevel:r.Yn.free,totalPoints:a,surplusPoints:a}],{session:t})},y=async({teamId:e})=>{let t=global.subPlans?.standard,[a,n]=await Promise.all([o.b.find({teamId:e}).lean(),(0,s.tB)(e)]),i=a.find(e=>e.type===r.cc.standard),c=a.filter(e=>e.type===r.cc.extraDatasetSize),d=a.filter(e=>e.type===r.cc.extraPoints);if(i&&i.expiredTime&&i.currentSubLevel===r.Yn.free&&l()(i.expiredTime).isBefore(new Date))return console.log("Init free stand plan",{teamId:e}),await p({teamId:e}),y({teamId:e});let u=t?(i?.totalPoints||0)+d.reduce((e,t)=>e+(t.totalPoints||0),0):1/0,m=(i?.surplusPoints||0)+d.reduce((e,t)=>e+(t.surplusPoints||0),0),f=i?.currentSubLevel&&t&&t[i.currentSubLevel]?.maxDatasetSize||1/0,g=f+c.reduce((e,t)=>e+(t.currentExtraDatasetSize||0),0);return{[r.cc.standard]:i,standardConstants:i?.currentSubLevel&&t?t[i.currentSubLevel]:void 0,totalPoints:u,usedPoints:u-m,datasetMaxSize:g,usedDatasetSize:n}};n()}catch(e){n(e)}})},34279:(e,t,a)=>{"use strict";a.d(t,{m:()=>r});var n=a(83249);let r=({model:e,tokens:t=0,modelType:a,multiple:r=1e3})=>{let o=n.yT?.[a]?.(e);if(!o)return{totalPoints:0,modelName:""};let s=(o.charsPointsPrice||0)*(t/r);return{modelName:o.name,totalPoints:s}}},72219:(e,t,a)=>{"use strict";a.d(t,{Sl:()=>i,YX:()=>l,ww:()=>n});var n,r=a(6162),o=a(71017),s=a.n(o);!function(e){e.readFile="readFile",e.htmlStr2Md="htmlStr2Md",e.countGptMessagesTokens="countGptMessagesTokens"}(n||(n={}));let i=e=>{let t=s().join(process.cwd(),".next","server","worker",`${e}.js`);return new r.Worker(t)},l=(e,t)=>new Promise((a,n)=>{let r=i(e);r.postMessage(t),r.on("message",e=>{if("error"===e.type)return n(e.data);a(e.data)}),r.on("error",e=>{r.terminate(),n(e)})})},23776:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.r(t),a.d(t,{default:()=>y,getInitConfig:()=>f,getSystemVersion:()=>h,initSystemConfig:()=>g});var r=a(56803),o=a(57147),s=a(85686),i=a(94459),l=a(26459),c=a(70605),d=a(77282),u=a(32170),m=a(47676),p=e([r,l]);async function y(e,t){await f(),(0,r.gH)(t,{data:{feConfigs:global.feConfigs,subPlans:global.subPlans,llmModels:global.llmModels,vectorModels:global.vectorModels,reRankModels:global.reRankModels?.map(e=>({...e,requestUrl:"",requestAuth:""}))||[],whisperModel:global.whisperModel,audioSpeechModels:global.audioSpeechModels,systemVersion:global.systemVersion||"0.0.0"}})}[r,l]=p.then?(await p)():p;let w={show_emptyChat:!0,show_git:!0,docUrl:"https://doc.fastgpt.in",openAPIDocUrl:"https://doc.fastgpt.in/docs/development/openapi",systemTitle:"FastGPT",concatMd:"项目开源地址: [FastGPT GitHub](https://github.com/labring/FastGPT)\n交流群: ![](https://oss.laf.run/htr4n1-images/fastgpt-qr-code.jpg)",limit:{exportDatasetLimitMinutes:0,websiteSyncLimitMinuted:0},scripts:[],favicon:"/favicon.ico",uploadFileMaxSize:500};async function f(){if(!global.systemInitd){global.systemInitd=!0;try{await (0,l.v)(),await Promise.all([g(),h(),function(){if(global.communityPlugins&&global.communityPlugins.length>0)return;let e="/app/data/pluginTemplates",t=(0,o.readdirSync)(e),a=t.filter(e=>e.endsWith(".json")),n=a.map(t=>{let a=(0,o.readFileSync)(`${e}/${t}`,"utf-8");return{...JSON.parse(a),id:`${s.C9.community}-${t.replace(".json","")}`,source:s.C9.community}});n.sort((e,t)=>t.weight-e.weight),global.communityPlugins=n}()]),console.log({communityPlugins:global.communityPlugins})}catch(e){console.error("Load init config error",e),global.systemInitd=!1,global.feConfigs||(0,d.exit)(1)}}}async function g(){let[e,t]=await Promise.all([(0,i.f)(),(0,c.b)("config.json")]),a=JSON.parse(t),n={feConfigs:{...a?.feConfigs,...w,...e.feConfigs||{},isPlus:!!u.v},systemEnv:{...a.systemEnv,...e.systemEnv||{}},subPlans:e.subPlans||a.subPlans,llmModels:e.llmModels||a.llmModels||[],vectorModels:e.vectorModels||a.vectorModels||[],reRankModels:e.reRankModels||a.reRankModels||[],audioSpeechModels:e.audioSpeechModels||a.audioSpeechModels||[],whisperModel:e.whisperModel||a.whisperModel};(0,m.Uo)(n),console.log({feConfigs:global.feConfigs,systemEnv:global.systemEnv,subPlans:global.subPlans,llmModels:global.llmModels,vectorModels:global.vectorModels,reRankModels:global.reRankModels,audioSpeechModels:global.audioSpeechModels,whisperModel:global.whisperModel})}function h(){if(!global.systemVersion)try{{let e=JSON.parse((0,o.readFileSync)("/app/package.json","utf-8"));global.systemVersion=e?.version}console.log(`System Version: ${global.systemVersion}`)}catch(e){console.log(e),global.systemVersion="0.0.0"}}n()}catch(e){n(e)}})},42033:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{E:()=>w});var r=a(74035),o=a(64461),s=a(17639),i=a(80184),l=a(94541),c=a(9819),d=a(97309),u=a.n(d),m=a(42436),p=e([o,i,m]);[o,i,m]=p.then?(await p)():p;let y=()=>{(0,r.b)("*/1 * * * *",()=>{(0,o.F)()})},f=()=>{(0,r.b)("*/10 * * * *",()=>{(0,s.yg)()})},g=()=>{(0,r.b)("0 */1 * * *",async()=>{await (0,l.s)({timerId:c.Y.checkInValidDatasetFiles,lockMinuted:59})&&(0,i.JQ)(u()(new Date,2),u()(new Date,6))}),(0,r.b)("10 */1 * * *",async()=>{await (0,l.s)({timerId:c.Y.checkInvalidDatasetData,lockMinuted:59})&&(0,i.aI)(u()(new Date,2),u()(new Date,6))}),(0,r.b)("30 */1 * * *",async()=>{await (0,l.s)({timerId:c.Y.checkInvalidVector,lockMinuted:59})&&(0,i.wB)(u()(new Date,2),u()(new Date,6))})},h=()=>{(0,r.b)("0 */1 * * *",async()=>{await (0,l.s)({timerId:c.Y.scheduleTriggerApp,lockMinuted:59})&&(0,m.A)()})},w=()=>{y(),f(),g(),h()};n()}catch(e){n(e)}})},80184:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{JQ:()=>m,aI:()=>p,wB:()=>y});var r=a(57749),o=a(5286),s=a(7161),i=a(6218),l=a(72912),c=a(83801),d=a(92677),u=e([r,i]);async function m(e,t){let a=0,n=(0,r.DW)("dataset"),o=await n.find({uploadDate:{$gte:e,$lte:t}},{projection:{metadata:1,_id:1}}).toArray();s.B.info(`Clear invalid dataset files, total files: ${o.length}`);let i=0;for await(let e of o)try{let t=await l.w.countDocuments({teamId:e.metadata.teamId,fileId:e._id});0===t&&(await (0,r.hh)({bucketName:"dataset",fileIdList:[String(e._id)]}),console.log("delete file",e._id),a++),++i%100==0&&console.log(i)}catch(e){console.log(e)}s.B.info(`Clear invalid dataset files finish, remove ${a} files`)}async function p(e,t){let a=await c.o.find({updateTime:{$gte:e,$lte:t}},"_id teamId datasetId collectionId").lean(),n=new Map;for(let e of a){let t=String(e.collectionId);n.has(t)||n.set(t,{teamId:e.teamId,datasetId:e.datasetId,collectionId:t})}let r=Array.from(n.values());s.B.info(`Clear invalid dataset data, total collections: ${r.length}`);let u=0;for await(let e of r){try{let t=await l.w.findOne({_id:e.collectionId});if(!t){await (0,o.w)(async t=>{await d.X.deleteMany({teamId:e.teamId,collectionId:e.collectionId},{session:t}),await c.o.deleteMany({teamId:e.teamId,collectionId:e.collectionId},{session:t}),await (0,i.VJ)({teamId:e.teamId,datasetIds:[e.datasetId],collectionIds:[e.collectionId]})}),console.log("collection is not found",e);continue}}catch(e){}console.log(++u)}}async function y(e,t){let a=0,n=await (0,i.wF)(e,t);s.B.info(`Clear invalid vector, total vector data: ${n.length}`);let r=0;for await(let e of n){if(!e.teamId||!e.datasetId||!e.id){s.B.error("error data",e);continue}try{let t=await c.o.countDocuments({teamId:e.teamId,datasetId:e.datasetId,"indexes.dataId":e.id});0===t&&(await (0,i.VJ)({teamId:e.teamId,id:e.id}),console.log("delete vector data",e.id),a++),++r%100==0&&console.log(r)}catch(e){console.log(e)}}s.B.info(`Clear invalid vector finish, remove ${a} data`)}[r,i]=u.then?(await u)():u,n()}catch(e){n(e)}})},70605:(e,t,a)=>{"use strict";a.d(t,{p:()=>s,b:()=>o});var n=a(59564),r=a(57147);let o=e=>{let t=e.split("."),a=(t[0],t[1],`/app/data/${e}`),n=(0,r.readFileSync)(a,"utf-8");return n};function s(){!global.communityPlugins&&(global.communityPlugins=[],global.qaQueueLen=global.qaQueueLen??0,global.vectorQueueLen=global.vectorQueueLen??0,process.env.AXIOS_PROXY_HOST&&process.env.AXIOS_PROXY_PORT&&(global.httpsAgent=n.httpsOverHttp({proxy:{host:process.env.AXIOS_PROXY_HOST,port:+process.env.AXIOS_PROXY_PORT}})))}},81798:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{S:()=>l});var r=a(23776),o=a(64461),s=a(83497),i=e([r,o]);[r,o]=i.then?(await i)():i;let l=async()=>{c(),(0,o.C)()},c=()=>{let e=s.E.watch();e.on("change",async e=>{try{"insert"===e.operationType&&(await (0,r.initSystemConfig)(),console.log("refresh system config"))}catch(e){}})};n()}catch(e){n(e)}})},42436:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{A:()=>m});var r=a(96897),o=a(11953),s=a(10071),i=a(73945),l=a(7161),c=a(65306),d=a(64286),u=e([r,d]);[r,d]=u.then?(await u)():u;let m=async()=>{let e=await c.p.find({scheduledTriggerConfig:{$ne:null},scheduledTriggerNextTime:{$lte:new Date}});await Promise.allSettled(e.map(async e=>{if(!e.scheduledTriggerConfig)return;await (0,s.g)(Math.floor(6e4*Math.random()));let{user:t}=await (0,r.xH)(e.tmbId);try{await (0,d.$f)({user:t,mode:"chat",teamId:String(e.teamId),tmbId:String(e.tmbId),appId:String(e._id),runtimeNodes:(0,i.v_)(e.modules,(0,i.I2)(e.modules)),runtimeEdges:(0,i.Zs)(e.edges),variables:{userChatInput:e.scheduledTriggerConfig?.defaultPrompt},histories:[],stream:!1,detail:!1,maxRunTimes:200})}catch(e){l.B.error("Schedule trigger error",e)}e.scheduledTriggerNextTime=(0,o.t2)(e.scheduledTriggerConfig),await e.save()}))};n()}catch(e){n(e)}})},58943:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Dv:()=>u,tu:()=>m,vh:()=>p});var r=a(83801),o=a(6218),s=a(32259),i=a(61292),l=a(83249),c=a(5286),d=e([o,s]);async function u({teamId:e,tmbId:t,datasetId:a,collectionId:n,q:c,a:d="",chunkIndex:u=0,indexes:m,model:p}){if(!c||!a||!n||!p)return console.log(c,d,a,n,p),Promise.reject("q, datasetId, collectionId, model is required");if(String(e)===String(t))return Promise.reject("teamId and tmbId can't be the same");let y=(0,s.Db)({q:c,a:d}).text;(m=Array.isArray(m)&&m.length>0?m.map(e=>({text:e.text,dataId:void 0,defaultIndex:e.text.trim()===y})):[(0,s.Db)({q:c,a:d})]).find(e=>e.defaultIndex)||m.unshift((0,s.Db)({q:c,a:d})),m=m.slice(0,6);let f=await Promise.all(m.map(t=>(0,o.TJ)({query:t.text,model:(0,l.BA)(p),teamId:e,datasetId:a,collectionId:n}))),{_id:g}=await r.o.create({teamId:e,tmbId:t,datasetId:a,collectionId:n,q:c,a:d,fullTextToken:(0,i.P)({text:y}),chunkIndex:u,indexes:m?.map((e,t)=>({...e,dataId:f[t].insertId}))});return{insertId:g,tokens:f.reduce((e,t)=>e+t.tokens,0)}}async function m({dataId:e,q:t,a,indexes:n,model:d}){if(!Array.isArray(n))return Promise.reject("indexes is required");let u=(0,s.Db)({q:t,a}).text,m=await r.o.findById(e);if(!m)return Promise.reject("core.dataset.error.Data not found");let p=n.map(e=>({...e,text:e.text.trim(),defaultIndex:e.text.trim()===u}));if(!p.find(e=>e.defaultIndex)){let e=m.indexes.find(e=>e.defaultIndex);p.unshift(e||(0,s.Db)({q:t,a}))}p=p.slice(0,6);let y=[];for(let e of m.indexes){let t=p.find(t=>t.dataId===e.dataId);t||y.push({type:"delete",index:e})}for(let e of p){let t=m.indexes.find(t=>t.dataId===e.dataId);if(t){if(t.defaultIndex&&t.text!==u){y.push({type:"update",index:{...t.toObject(),text:u}});continue}if(t.text!==e.text){y.push({type:"update",index:e});continue}y.push({type:"unChange",index:e})}else y.push({type:"create",index:e})}m.updateTime=new Date,await m.save();let f=JSON.parse(JSON.stringify(y)),g=await Promise.all(f.map(async e=>{if("create"===e.type||"update"===e.type){let t=await (0,o.TJ)({query:e.index.text,model:(0,l.BA)(d),teamId:m.teamId,datasetId:m.datasetId,collectionId:m.collectionId});return e.index.dataId=t.insertId,t}return{tokens:0}})),h=g.reduce((e,t)=>e+t.tokens,0);return await (0,c.w)(async e=>{let n=f.filter(e=>"delete"!==e.type).map(e=>e.index);m.q=t||m.q,m.a=a??m.a,m.fullTextToken=(0,i.P)({text:m.q+m.a}),m.indexes=n,await m.save({session:e});let r=y.filter(e=>"delete"===e.type||"update"===e.type).map(e=>e.index.dataId).filter(Boolean);r.length>0&&await (0,o.VJ)({teamId:m.teamId,idList:r})}),{tokens:h}}[o,s]=d.then?(await d)():d;let p=async e=>{await (0,c.w)(async t=>{await r.o.findByIdAndDelete(e.id,{session:t}),await (0,o.VJ)({teamId:e.teamId,idList:e.indexes.map(e=>e.dataId)})})};n()}catch(e){n(e)}})},64461:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{C:()=>c,F:()=>d});var r=a(43701),o=a(7311),s=a(89645),i=a(92677),l=e([r,o]);[r,o]=l.then?(await l)():l;let c=()=>{let e=i.X.watch();e.on("change",async e=>{try{if("insert"===e.operationType){let t=e.fullDocument,{mode:a}=t;a===s.g0.qa?(0,r.E)():a===s.g0.chunk&&(0,o.o)()}}catch(e){}})},d=e=>{let t=global.systemEnv?.qaMaxProcess||10;for(let a=0;a<(e?t:1);a++)(0,r.E)(),(0,o.o)()};n()}catch(e){n(e)}})},43701:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{E:()=>v});var r=a(92677),o=a(65026),s=a(89645),i=a(81190),l=a(7161),c=a(59666),d=a(935),u=a(44201),m=a(83249),p=a(88778),y=a(86700),f=a(45569),g=a.n(f),h=a(7110),w=a(59659),b=e([o,c,d,p,y,h,w]);[o,c,d,p,y,h,w]=b.then?(await b)():b;let I=()=>(global.qaQueueLen=global.qaQueueLen>0?global.qaQueueLen-1:0,0===global.qaQueueLen);async function v(){let e=global.systemEnv?.qaMaxProcess||10;if(global.qaQueueLen>=e)return;global.qaQueueLen++;let t=Date.now(),{data:a,text:n,done:f=!1,error:b=!1}=await (async()=>{try{let e=await r.X.findOneAndUpdate({lockTime:{$lte:g()(new Date,-6)},mode:s.g0.qa},{lockTime:new Date}).select({_id:1,userId:1,teamId:1,tmbId:1,datasetId:1,collectionId:1,q:1,model:1,chunkIndex:1,billId:1,prompt:1}).lean();if(!e)return{done:!0};return{data:e,text:e.q}}catch(e){return l.B.error("[QA Queue] Error",e),{error:!0}}})();if(f||!a){I()&&l.B.info("[QA Queue] Done");return}if(b||!await (0,p.z)(a.teamId,a.tmbId))return I(),v();l.B.info("[QA Queue] Start");try{let e=m.DA(a.model)?.model,p=`${a.prompt||u.c5.description}
${(0,d.Fm)(u.c5.fixedText,{text:n})}`,y=[{role:"user",content:p}],f=(0,i.c)({timeout:6e5}),g=await f.chat.completions.create({model:e,temperature:.3,messages:y,stream:!1}),b=g.choices?.[0].message?.content||"",x=function(e,t){e=e.replace(/\\n/g,"\n");let a=e.matchAll(/Q\d+:(\s*)(.*)(\s*)A\d+:(\s*)([\s\S]*?)(?=Q\d|$)/g),n=[];for(let e of a){let t=e[2]||"",a=e[5]||"";t&&n.push({q:t,a,indexes:[{defaultIndex:!0,text:`${t}
${a.trim().replace(/\n\s*/g,"\n")}`}]})}if(0===n.length){let{chunks:e}=(0,c.N)({text:t,chunkLen:512});e.forEach(e=>{n.push({q:e,a:"",indexes:[{defaultIndex:!0,text:e}]})})}return n}(b,n);l.B.info("[QA Queue] Finish",{time:Date.now()-t,splitLength:x.length,usage:g.usage});let{insertLen:T}=await (0,w.W9)({teamId:a.teamId,tmbId:a.tmbId,collectionId:a.collectionId,trainingMode:s.g0.chunk,data:x.map(e=>({...e,chunkIndex:a.chunkIndex})),billId:a.billId});await r.X.findByIdAndDelete(a._id),T>0?(0,o.cx)({teamId:a.teamId,tmbId:a.tmbId,tokens:await (0,h.et)(y),billId:a.billId,model:e}):l.B.info("QA result 0:",{answer:b}),I(),v()}catch(e){if(I(),await (0,y.Q)({err:e,data:a,errText:"QA模型调用失败"}))return v();setTimeout(()=>{v()},1e3)}}n()}catch(e){n(e)}})},7311:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{o:()=>y});var r=a(58943),o=a(92677),s=a(89645),i=a(65026),l=a(88778),c=a(86700),d=a(45569),u=a.n(d),m=a(7161),p=e([r,i,l,c]);[r,i,l,c]=p.then?(await p)():p;let f=()=>(global.vectorQueueLen=global.vectorQueueLen>0?global.vectorQueueLen-1:0,0===global.vectorQueueLen);async function y(){let e=global.systemEnv?.vectorMaxProcess||10;if(global.vectorQueueLen>=e)return;global.vectorQueueLen++;let t=Date.now(),{data:a,dataItem:n,done:d=!1,error:p=!1}=await (async()=>{try{let e=await o.X.findOneAndUpdate({mode:s.g0.chunk,lockTime:{$lte:u()(new Date,-1)}},{lockTime:new Date}).select({_id:1,userId:1,teamId:1,tmbId:1,datasetId:1,collectionId:1,q:1,a:1,chunkIndex:1,indexes:1,model:1,billId:1});if(!e)return{done:!0};return{data:e,dataItem:{q:e.q,a:e.a||"",indexes:e.indexes}}}catch(e){return m.B.error("Get Training Data error",e),{error:!0}}})();if(d||!a){f()&&m.B.info("[Vector Queue] Done");return}if(p)return m.B.error("[Vector Queue] Error",{error:p}),f(),y();if(!await (0,l.z)(a.teamId,a.tmbId))return f(),y();m.B.info("[Vector Queue] Start");try{if(!a.q.trim()){await a.deleteOne(),f(),y();return}let{tokens:e}=await (0,r.Dv)({teamId:a.teamId,tmbId:a.tmbId,datasetId:a.datasetId,collectionId:a.collectionId,q:n.q,a:n.a,chunkIndex:a.chunkIndex,indexes:n.indexes,model:a.model});(0,i.b_)({teamId:a.teamId,tmbId:a.tmbId,tokens:e,model:a.model,billId:a.billId}),await a.deleteOne(),f(),y(),m.B.info("[Vector Queue] Finish",{time:Date.now()-t})}catch(e){if(f(),await (0,c.Q)({err:e,data:a,errText:"向量模型调用失败"}))return y();setTimeout(()=>{y()},1e3)}}n()}catch(e){n(e)}})},88778:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{z:()=>d});var r=a(77490),o=a(83783),s=a(57924),i=a(59659),l=a(68930),c=e([o,s,i]);[o,s,i]=c.then?(await c)():c;let d=async(e,t)=>{try{return await (0,o.qd)(e),!0}catch(a){if(a===r.T.aiPointsNotEnough)try{(0,s.r)({level:l.V.important,title:"文本训练任务中止",content:"该团队账号AI积分不足，文本训练任务中止，重新充值后将会继续。暂停的任务将在 7 天后被删除。",tmbId:t}),console.log("余额不足，暂停【向量】生成任务"),(0,i.I2)(e)}catch(e){}return!1}};n()}catch(e){n(e)}})},26459:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{v:()=>w});var r=a(82702),o=a(80759),s=a(98312),i=a(935),l=a(17546),c=a(77282),d=a(6218),u=a(23776),m=a(42033),p=a(5286),y=a(70605),f=a(81798),g=a(64461),h=e([o,i,l,d,u,m,f,g]);function w(){return(0,s.Q)({beforeHook:()=>{(0,y.p)()},afterHook:async()=>{(0,u.getInitConfig)(),await Promise.all([(0,d.Oj)(),b()]),(0,f.S)(),(0,m.E)(),(0,g.F)(!0)}})}async function b(e=3){try{let e=await o.j.findOne({username:"root"}),t=process.env.DEFAULT_ROOT_PSW||"123456",a=e?._id||"";await (0,p.w)(async n=>{if(e)await e.updateOne({password:(0,i.ck)(t)});else{let[{_id:e}]=await o.j.create([{username:"root",password:(0,i.ck)(t)}],{session:n});a=e}await (0,l.hP)({userId:a,balance:9999*r.r,session:n})}),console.log("root user init:",{username:"root",password:t})}catch(t){if(e>0)return console.log("retry init root user"),b(e-1);console.error("init root user error",t),(0,c.exit)(1)}}[o,i,l,d,u,m,f,g]=h.then?(await h)():h,n()}catch(e){n(e)}})},96897:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{Z6:()=>d,xH:()=>c});var r=a(72073),o=a(63442),s=a(83783),i=a(17405),l=e([o,s,i]);async function c(e){let t=await o.d.findById(e,"teamId userId").populate("userId","timezone openaiAccount");return t?(await (0,s.qd)(t.teamId),{user:t.userId}):Promise.reject(r.c.unAuthUser)}async function d({teamId:e,teamToken:t}){let a=await (0,i.HT)("/support/user/team/tag/authTeamToken",{teamId:e,teamToken:t}),n=a.uid;return{uid:n}}[o,s,i]=l.then?(await l)():l,n()}catch(e){n(e)}})},57924:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{r:()=>i});var r=a(17405),o=a(32170),s=e([r]);function i(e){if(o.v)return(0,r.a4)("/support/user/inform/create",e)}r=(s.then?(await s)():s)[0],n()}catch(e){n(e)}})},96515:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{j:()=>l,m:()=>c});var r=a(7161),o=a(17405),s=a(32170),i=e([o]);function l(e){if(s.v){0===e.totalPoints&&r.B.info("0 totalPoints",e);try{(0,o.a4)("/support/wallet/usage/createUsage",e)}catch(e){}}}function c(e){if(s.v){0===e.totalPoints&&r.B.info("0 totalPoints",e);try{(0,o.a4)("/support/wallet/usage/concatUsage",e)}catch(e){}}}o=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})},65026:(e,t,a)=>{"use strict";a.a(e,async(e,n)=>{try{a.d(t,{EK:()=>m,JF:()=>f,b_:()=>y,cx:()=>p,sU:()=>u,te:()=>d});var r=a(97287),o=a(83249),s=a(7161),i=a(96515),l=a(34279),c=e([i]);i=(c.then?(await c)():c)[0];let m=({appName:e,appId:t,pluginId:a,teamId:n,tmbId:r,source:o,flowUsages:l})=>{let c=l.reduce((e,t)=>e+(t.totalPoints||0),0);return(0,i.j)({teamId:n,tmbId:r,appName:e,appId:t,pluginId:a,totalPoints:c,source:o,list:l.map(e=>({moduleName:e.moduleName,amount:e.totalPoints||0,model:e.model,tokens:e.tokens}))}),s.B.info("finish completions",{source:o,teamId:n,tmbId:r,totalPoints:c}),{totalPoints:c}},p=async({teamId:e,tmbId:t,model:a,tokens:n,billId:r})=>{let{totalPoints:s}=(0,l.m)({model:a,modelType:o.Mj.llm,tokens:n});return console.log(n,"----"),(0,i.m)({billId:r,teamId:e,tmbId:t,totalPoints:s,tokens:n,listIndex:1}),{totalPoints:s}},y=({billId:e,teamId:t,tmbId:a,tokens:n,model:s,source:c=r.u.fastgpt,extensionModel:d,extensionTokens:u})=>{let{totalPoints:m,modelName:p}=(0,l.m)({modelType:o.Mj.vector,model:s,tokens:n}),{extensionTotalPoints:y,extensionModelName:f}=(()=>{if(!d||!u)return{extensionTotalPoints:0,extensionModelName:""};let{totalPoints:e,modelName:t}=(0,l.m)({modelType:o.Mj.llm,model:d,tokens:u});return{extensionTotalPoints:e,extensionModelName:t}})(),g=m+y;return e?(0,i.m)({teamId:t,tmbId:a,totalPoints:g,billId:e,tokens:n,listIndex:0}):(0,i.j)({teamId:t,tmbId:a,appName:"support.wallet.moduleName.index",totalPoints:g,source:c,list:[{moduleName:"support.wallet.moduleName.index",amount:m,model:p,tokens:n},...void 0!==d?[{moduleName:"core.module.template.Query extension",amount:y,model:f,tokens:u}]:[]]}),{totalPoints:g}},f=({tokens:e,teamId:t,tmbId:a})=>{let n=global.llmModels[0],{totalPoints:s,modelName:c}=(0,l.m)({tokens:e,model:n.model,modelType:o.Mj.llm});(0,i.j)({teamId:t,tmbId:a,appName:"core.app.Question Guide",totalPoints:s,source:r.u.fastgpt,list:[{moduleName:"core.app.Question Guide",amount:s,model:c,tokens:e}]})};function d({appName:e="support.wallet.usage.Audio Speech",model:t,charsLength:a,teamId:n,tmbId:s,source:c=r.u.fastgpt}){let{totalPoints:d,modelName:u}=(0,l.m)({model:t,tokens:a,modelType:o.Mj.audioSpeech});(0,i.j)({teamId:n,tmbId:s,appName:e,totalPoints:d,source:c,list:[{moduleName:e,amount:d,model:u,charsLength:a}]})}function u({teamId:e,tmbId:t,duration:a}){let n=global.whisperModel;if(!n)return;let{totalPoints:s,modelName:c}=(0,l.m)({model:n.model,tokens:a,modelType:o.Mj.whisper,multiple:60}),d="support.wallet.usage.Whisper";(0,i.j)({teamId:e,tmbId:t,appName:d,totalPoints:s,source:r.u.fastgpt,list:[{moduleName:d,amount:s,model:c,duration:a}]})}n()}catch(e){n(e)}})}};